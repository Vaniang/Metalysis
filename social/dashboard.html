<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Dashboard | R1AA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- CSS STYLES --- */
        :root { 
            --primary: #1e3a8a; --secondary: #3b82f6; 
            --dark: #0f172a; --light: #f1f5f9; --white: #ffffff;
            --gold: #fbbf24; --silver: #cbd5e1; --bronze: #b45309;
            --social-pink: #ec4899;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #334155; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 10; }
        .feed-header { padding: 20px; border-bottom: 1px solid #e2e8f0; font-weight: 800; color: var(--dark); display: flex; justify-content: space-between; align-items: center; }
        
        /* Graphic Type Selector */
        .mode-selector { display: flex; gap: 5px; padding: 10px 15px; border-bottom: 1px solid #e2e8f0; overflow-x: auto; }
        .mode-btn { border: none; background: #f1f5f9; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: #64748b; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .mode-btn.active { background: var(--primary); color: white; }
        
        /* Inputs Area */
        .controls-area { flex: 1; padding: 20px; overflow-y: auto; }
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px; display: block; text-transform: uppercase; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: inherit; font-size: 0.9rem; }
        
        /* Feed List (Only visible in Winner/Podium mode) */
        .feed-list { border: 1px solid #e2e8f0; border-radius: 8px; max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .feed-item { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 0.85rem; }
        .feed-item:hover { background: #f8fafc; }
        
        /* RIGHT: WORKSPACE */
        .workspace { flex: 1; background: #cbd5e1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; overflow: hidden; position: relative; }
        
        /* --- UNIVERSAL CARD CONTAINER --- */
        .social-card {
            width: 800px; height: 800px; /* Square for FB/IG */
            background: linear-gradient(135deg, #002855 0%, #001f3f 100%);
            position: relative;
            display: flex; flex-direction: column;
            text-align: center; color: white;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.5);
            border: 8px solid #fbbf24; /* Default Gold Border */
            overflow: hidden; flex-shrink: 0;
            transform: scale(0.7); /* Scale down to fit screen */
        }

        /* HEADER (Logos) */
        .card-header { height: 180px; padding-top: 30px; display: flex; flex-direction: column; align-items: center; z-index: 2; }
        .main-logo { height: 100px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .header-title { font-family: 'Oswald', sans-serif; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; }

        /* BODY (Dynamic Content) */
        .card-body { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; z-index: 2; position: relative; }

        /* FOOTER (Logos) */
        .card-footer { height: 100px; background: white; display: flex; justify-content: center; align-items: center; gap: 30px; z-index: 2; }
        .footer-logo { height: 60px; object-fit: contain; }

        /* --- LAYOUTS --- */
        
        /* 1. WINNER LAYOUT */
        .layout-winner .medal-icon { font-size: 120px; margin-bottom: 20px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); }
        .layout-winner .event-name { font-family: 'Oswald', sans-serif; font-size: 2.5rem; text-transform: uppercase; margin-bottom: 10px; color: #e2e8f0; }
        .layout-winner .winner-name { font-size: 4rem; font-weight: 900; text-transform: uppercase; line-height: 1; margin-bottom: 10px; color: #fbbf24; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .layout-winner .winner-sdo { font-size: 2rem; font-weight: 500; text-transform: uppercase; letter-spacing: 3px; }

        /* 2. PODIUM LAYOUT */
        .podium-grid { display: grid; grid-template-columns: 1fr 1.2fr 1fr; align-items: end; gap: 20px; width: 90%; margin-bottom: 40px; }
        .podium-item { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .podium-rank { font-family: 'Oswald', sans-serif; font-size: 4rem; font-weight: 700; line-height: 1; }
        .podium-name { font-size: 1.2rem; font-weight: 700; margin-top: 10px; text-transform: uppercase; }
        .podium-sdo { font-size: 0.9rem; opacity: 0.8; text-transform: uppercase; }
        .rank-1 { color: #fbbf24; transform: scale(1.1); border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .rank-2 { color: #cbd5e1; border-color: #cbd5e1; }
        .rank-3 { color: #b45309; border-color: #b45309; }

        /* 3. TALLY LAYOUT */
        .tally-list { width: 80%; }
        .tally-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px 30px; margin-bottom: 10px; border-radius: 8px; }
        .tally-rank { font-weight: 900; font-size: 1.5rem; width: 40px; }
        .tally-sdo { font-weight: 700; font-size: 1.5rem; flex: 1; text-align: left; text-transform: uppercase; }
        .tally-medals { display: flex; gap: 15px; font-weight: 700; font-size: 1.5rem; }
        .tm-g { color: #fbbf24; } .tm-s { color: #cbd5e1; } .tm-b { color: #d97706; }

        /* 4. VS MATCH LAYOUT */
        .match-container { display: flex; align-items: center; justify-content: space-between; width: 90%; }
        .team-box { width: 35%; display: flex; flex-direction: column; align-items: center; }
        .team-logo-ph { width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .team-name { font-size: 2rem; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
        .match-score { font-family: 'Oswald', sans-serif; font-size: 6rem; font-weight: 700; color: #fbbf24; }
        .vs-text { font-size: 2rem; font-weight: 900; opacity: 0.5; margin: 0 20px; }

        /* Background Watermark */
        .bg-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; opacity: 0.05; z-index: 0; pointer-events: none; }

        /* Action Bar */
        .action-bar { position: absolute; bottom: 30px; display: flex; gap: 15px; z-index: 100; }
        .action-btn { padding: 12px 25px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .btn-dl { background: #fbbf24; color: #0f172a; } .btn-dl:hover { transform: translateY(-3px); }
        .btn-copy { background: white; color: #334155; } .btn-copy:hover { transform: translateY(-3px); }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="feed-header">
            <span>GRAPHIC BUILDER</span>
            <i class="fas fa-paint-brush" style="color:var(--social-pink);"></i>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('winner')">üèÜ Winner</button>
            <button class="mode-btn" onclick="setMode('podium')">üèÖ Podium</button>
            <button class="mode-btn" onclick="setMode('tally')">üìä Tally</button>
            <button class="mode-btn" onclick="setMode('match')">üÜö Match</button>
        </div>

        <div class="controls-area" id="controls">
            </div>
    </aside>

    <div class="workspace">
        
        <div id="socialCard" class="social-card layout-winner">
            <img src="assets/r1aa_logo.png" class="bg-watermark">

            <div class="card-header">
                <img src="assets/r1aa_logo.png" class="main-logo">
                <div class="header-title">Region 1 Athletic Association Meet 2026</div>
            </div>

            <div class="card-body" id="cardBody">
                </div>

            <div class="card-footer">
                <img src="assets/deped_logo.png" class="footer-logo" onerror="this.style.display='none'">
                <img src="assets/host_logo.png" class="footer-logo" onerror="this.style.display='none'">
                <img src="assets/lgu_logo.png" class="footer-logo" onerror="this.style.display='none'">
                <img src="assets/mayor_logo.png" class="footer-logo" onerror="this.style.display='none'">
            </div>
        </div>

        <div class="action-bar">
            <button class="action-btn btn-dl" onclick="downloadCard()"><i class="fas fa-download"></i> Download PNG</button>
            <button class="action-btn btn-copy" onclick="generateCaption()"><i class="fas fa-copy"></i> Copy Caption</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let GLOBAL_DATA = [];
        let CURRENT_MODE = 'winner';

        // --- DATA LISTENER ---
        const q = query(collection(db, "game_results"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            GLOBAL_DATA = [];
            snapshot.forEach(doc => GLOBAL_DATA.push(doc.data()));
            renderControls(); // Refresh list
        });

        // --- CONTROLS RENDERER ---
        window.setMode = (mode) => {
            CURRENT_MODE = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderControls();
            
            // Reset Card Class
            const card = document.getElementById('socialCard');
            card.className = `social-card layout-${mode}`;
            
            // Initial Render of empty state
            if(mode === 'tally') renderTallyCard();
            else if(mode === 'match') renderMatchCard();
        };

        function renderControls() {
            const container = document.getElementById('controls');
            container.innerHTML = '';

            if (CURRENT_MODE === 'winner') {
                container.innerHTML = `<div class="input-label">Select Recent Result</div>`;
                const list = document.createElement('div');
                list.className = 'feed-list';
                GLOBAL_DATA.forEach(d => {
                    const item = document.createElement('div');
                    item.className = 'feed-item';
                    item.innerHTML = `<strong>${d.athleteName}</strong> (${d.medal})<br><span style="color:#94a3b8">${d.event}</span>`;
                    item.onclick = () => renderWinnerCard(d);
                    list.appendChild(item);
                });
                container.appendChild(list);
            } 
            else if (CURRENT_MODE === 'podium') {
                container.innerHTML = `
                    <div class="input-group">
                        <label class="input-label">Event Title</label>
                        <input type="text" class="input-field" id="inEvent" value="100M Dash - Boys" oninput="updatePodiumText()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Gold Winner</label>
                        <input type="text" class="input-field" id="inGold" placeholder="Name - SDO" oninput="updatePodiumText()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Silver Winner</label>
                        <input type="text" class="input-field" id="inSilver" placeholder="Name - SDO" oninput="updatePodiumText()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Bronze Winner</label>
                        <input type="text" class="input-field" id="inBronze" placeholder="Name - SDO" oninput="updatePodiumText()">
                    </div>
                `;
                renderPodiumCard();
            }
            else if (CURRENT_MODE === 'match') {
                container.innerHTML = `
                    <div class="input-group">
                        <label class="input-label">Event</label>
                        <input type="text" class="input-field" id="matchEvent" value="BASKETBALL BOYS" oninput="updateMatchCard()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Team A</label>
                        <input type="text" class="input-field" id="teamA" value="ILOCOS NORTE" oninput="updateMatchCard()">
                        <input type="number" class="input-field" id="scoreA" value="85" style="margin-top:5px;" oninput="updateMatchCard()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Team B</label>
                        <input type="text" class="input-field" id="teamB" value="LA UNION" oninput="updateMatchCard()">
                        <input type="number" class="input-field" id="scoreB" value="82" style="margin-top:5px;" oninput="updateMatchCard()">
                    </div>
                `;
                renderMatchCard();
            }
            else if (CURRENT_MODE === 'tally') {
                container.innerHTML = `<div style="text-align:center; color:#64748b; padding:20px;">Top 5 SDOs Auto-Generated from Data</div>`;
                renderTallyCard();
            }
        }

        // --- CARD RENDERERS ---

        window.renderWinnerCard = (d) => {
            const body = document.getElementById('cardBody');
            let medalColor = d.medal === 'GOLD' ? '#fbbf24' : d.medal === 'SILVER' ? '#cbd5e1' : '#b45309';
            
            body.innerHTML = `
                <i class="fas fa-medal medal-icon" style="color:${medalColor}; font-size:80px; margin-bottom:10px;"></i>
                <div class="category-pill" style="border:1px solid ${medalColor}; color:${medalColor}">${d.category}</div>
                <div class="event-name">${d.event}</div>
                <div class="winner-name" style="color:${medalColor}">${d.athleteName}</div>
                <div class="winner-sdo">${d.sdo}</div>
            `;
            document.getElementById('socialCard').style.borderColor = medalColor;
        };

        window.renderPodiumCard = () => {
            const body = document.getElementById('cardBody');
            body.innerHTML = `
                <div class="event-name" id="podEventDisplay" style="margin-bottom:30px;">EVENT NAME</div>
                <div class="podium-grid">
                    <div class="podium-item rank-2">
                        <div class="podium-rank">2</div>
                        <div class="podium-name" id="dispSilver">Silver Name</div>
                        <div class="podium-sdo">SDO</div>
                    </div>
                    <div class="podium-item rank-1">
                        <div class="podium-rank">1</div>
                        <div class="podium-name" id="dispGold">Gold Name</div>
                        <div class="podium-sdo">SDO</div>
                    </div>
                    <div class="podium-item rank-3">
                        <div class="podium-rank">3</div>
                        <div class="podium-name" id="dispBronze">Bronze Name</div>
                        <div class="podium-sdo">SDO</div>
                    </div>
                </div>
            `;
            document.getElementById('socialCard').style.borderColor = '#fbbf24';
        };

        window.updatePodiumText = () => {
            document.getElementById('podEventDisplay').innerText = document.getElementById('inEvent').value;
            document.getElementById('dispGold').innerText = document.getElementById('inGold').value || "Winner";
            document.getElementById('dispSilver').innerText = document.getElementById('inSilver').value || "Winner";
            document.getElementById('dispBronze').innerText = document.getElementById('inBronze').value || "Winner";
        };

        window.renderMatchCard = () => {
            const body = document.getElementById('cardBody');
            document.getElementById('socialCard').style.borderColor = '#fff';
            
            // Get values safely
            const event = document.getElementById('matchEvent') ? document.getElementById('matchEvent').value : "EVENT";
            const tA = document.getElementById('teamA') ? document.getElementById('teamA').value : "TEAM A";
            const sA = document.getElementById('scoreA') ? document.getElementById('scoreA').value : "00";
            const tB = document.getElementById('teamB') ? document.getElementById('teamB').value : "TEAM B";
            const sB = document.getElementById('scoreB') ? document.getElementById('scoreB').value : "00";

            body.innerHTML = `
                <div class="category-pill">MATCH RESULT</div>
                <div class="event-name" style="margin-bottom:40px;">${event}</div>
                <div class="match-container">
                    <div class="team-box">
                        <div class="team-logo-ph">${tA.charAt(0)}</div>
                        <div class="team-name">${tA}</div>
                        <div class="match-score">${sA}</div>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="team-box">
                        <div class="team-logo-ph">${tB.charAt(0)}</div>
                        <div class="team-name">${tB}</div>
                        <div class="match-score">${sB}</div>
                    </div>
                </div>
            `;
        };
        window.updateMatchCard = renderMatchCard; // Bind update function

        window.renderTallyCard = () => {
            const body = document.getElementById('cardBody');
            document.getElementById('socialCard').style.borderColor = '#fff';
            
            // Calculate Tally
            let tally = {};
            GLOBAL_DATA.forEach(d => {
                if(!tally[d.sdo]) tally[d.sdo] = {G:0, S:0, B:0};
                if(d.medal) tally[d.sdo][d.medal.charAt(0)]++;
            });
            const top5 = Object.keys(tally).sort((a,b) => tally[b].G - tally[a].G).slice(0, 5);

            let html = `<div class="event-name" style="margin-bottom:20px;">MEDAL TALLY UPDATE</div><div class="tally-list">`;
            top5.forEach((sdo, idx) => {
                html += `
                    <div class="tally-row">
                        <div class="tally-rank">${idx+1}</div>
                        <div class="tally-sdo">${sdo}</div>
                        <div class="tally-medals">
                            <span class="tm-g"><i class="fas fa-circle"></i> ${tally[sdo].G}</span>
                            <span class="tm-s"><i class="fas fa-circle"></i> ${tally[sdo].S}</span>
                            <span class="tm-b"><i class="fas fa-circle"></i> ${tally[sdo].B}</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            body.innerHTML = html;
        };

        // --- ACTIONS ---
        window.downloadCard = () => {
            const card = document.getElementById('socialCard');
            // Reset scaling for clear capture
            card.style.transform = "scale(1)";
            
            html2canvas(card, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `R1AA_Graphic_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // Restore preview scale
                card.style.transform = "scale(0.7)";
            });
        };

        window.generateCaption = () => {
            alert("Caption generation coming soon based on card type!");
        };

        // Initial Load
        renderControls();
        renderWinnerCard({medal:'GOLD', category:'CATEGORY', event:'EVENT', athleteName:'SELECT RESULT', sdo:'DELEGATION'});

    </script>
</body>
</html>
