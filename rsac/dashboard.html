<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSAC Dashboard | R1AA System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #0056b3;
            --dark: #1e293b;
            --light: #f1f5f9;
            --white: #ffffff;
            --gray: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); }

        .dashboard-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: var(--white); display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid #334155; display: flex; gap: 10px; align-items: center; }
        .brand i { color: #fdd835; }
        .nav-links { flex: 1; padding-top: 20px; }
        .nav-links a { display: flex; gap: 15px; padding: 15px 25px; color: #cbd5e1; text-decoration: none; transition: 0.2s; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { background: #334155; color: var(--white); border-left: 4px solid var(--primary); }

        /* Notification Badge */
        .notification-wrapper { position: relative; cursor: pointer; margin-left: auto; margin-right: 20px; }
        .bell-icon { font-size: 1.5rem; color: var(--dark); }
        .badge-count { 
            position: absolute; top: -5px; right: -5px; 
            background: var(--danger); color: white; 
            border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;
            display: none; /* Hidden by default */
        }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }

        /* Controls */
        .controls-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); align-items: center; }
        .controls-bar input, .controls-bar select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; display: flex; gap: 8px; align-items: center; font-size: 0.9rem; }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #000; }

        /* Tables */
        .table-container { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; }
        th { background: #f8fafc; color: var(--gray); font-weight: 700; text-transform: uppercase; white-space: nowrap; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card p { font-size: 2rem; font-weight: bold; margin-top: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .form-group textarea, .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }

        @media print {
            .sidebar, .controls-bar, .btn, .notification-wrapper { display: none !important; }
            .dashboard-container { display: block; }
            .main-content { padding: 0; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-id-badge"></i>
                <span>RSAC Admin</span>
            </div>
            <nav class="nav-links">
                <a onclick="showSection('dashboard')" class="active" id="nav-dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a onclick="showSection('athletes')" id="nav-athletes"><i class="fas fa-users"></i> List of Athletes</a>
                <a onclick="showSection('awards')" id="nav-awards"><i class="fas fa-medal"></i> Athletes Award</a>
                <a onclick="showSection('protests')" id="nav-protests"><i class="fas fa-gavel"></i> Protests</a>
                <a id="logoutBtn" style="margin-top: auto; border-top: 1px solid #334155;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <div class="notification-wrapper" onclick="showSection('protests')">
                    <i class="fas fa-bell bell-icon"></i>
                    <span id="notifBadge" class="badge-count">0</span>
                </div>
            </div>

            <div id="dashboard" class="section active">
                <h2>Real-Time Data</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: var(--primary);">
                        <h3>Registered Athletes</h3>
                        <p id="stat-total-athletes">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <h3>Pending Protests</h3>
                        <p id="stat-pending-protests">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <h3>Resolved Cases</h3>
                        <p id="stat-resolved-protests">0</p>
                    </div>
                </div>
            </div>

            <div id="athletes" class="section">
                <h2>List of Athletes</h2>
                <div class="controls-bar">
                    <input type="text" id="filterName" placeholder="Search Name..." onkeyup="filterAthletes()">
                    <select id="filterDivision" onchange="filterAthletes()">
                        <option value="">All Divisions</option>
                        <option>Ilocos Norte</option>
                        <option>Ilocos Sur</option>
                        <option>La Union</option>
                        <option>Pangasinan I</option>
                        <option>Pangasinan II</option>
                    </select>
                    <select id="filterCategory" onchange="filterAthletes()">
                        <option value="">All Categories</option>
                        <option>Elementary</option>
                        <option>Secondary</option>
                    </select>
                    <select id="filterYear" onchange="filterAthletes()">
                        <option value="">All Year Levels</option>
                        <option>Grade 7</option>
                        <option>Grade 8</option>
                        <option>Grade 9</option>
                        <option>Grade 10</option>
                        <option>Grade 11</option>
                        <option>Grade 12</option>
                    </select>
                    <button class="btn btn-success" onclick="exportTableToExcel('athleteTable')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                </div>
                <div class="table-container">
                    <table id="athleteTable">
                        <thead>
                            <tr>
                                <th>Passport No.</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Category</th>
                                <th>Year Level</th>
                                <th>Sport</th>
                                <th>Division</th>
                                <th>Wt (kg)</th>
                                <th>Ht (cm)</th>
                                <th>Birthdate</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="athleteTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="awards" class="section">
                <h2>Athletes Award</h2>
                <div class="controls-bar">
                    <input type="text" id="searchAward" placeholder="Search Winner Name...">
                    <select id="filterAwardDivision"><option value="">All Divisions</option></select>
                    <button class="btn btn-success" onclick="exportTableToExcel('awardTable')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                </div>
                <div class="table-container">
                    <table id="awardTable">
                        <thead>
                            <tr>
                                <th>Athlete Name</th>
                                <th>Division</th>
                                <th>Event Joined</th>
                                <th>Medal Received</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="awardTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="protests" class="section">
                <h2>Protest Management</h2>
                <div class="controls-bar">
                    <p style="font-size: 0.9rem; color: var(--gray);">*Inputs are filed by Tabulation Team. RSAC provides resolution.</p>
                </div>
                <div class="table-container">
                    <table id="protestTable">
                        <thead>
                            <tr>
                                <th>Protester</th>
                                <th>Respondent (Protestee)</th>
                                <th>Description</th>
                                <th>Resolution</th>
                                <th>Settlement</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="protestTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="resolveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Resolve Protest</h3>
            <form id="resolveForm">
                <input type="hidden" id="protestIdToResolve">
                <div class="form-group">
                    <label>Resolution Decision</label>
                    <textarea id="resDecision" rows="3" placeholder="State the official decision..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Settlement / Agreement</label>
                    <textarea id="resSettlement" rows="3" placeholder="Details of agreement between parties..." required></textarea>
                </div>
                <button type="submit" class="btn btn-success" style="width:100%">Mark as RESOLVED</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH & NAVIGATION ---
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "../index.html";
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });

        window.showSection = (id) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
        };

        // --- 1. ATHLETES (Read + Edit/Delete only) ---
        // Listens to data input by Tabulation Team
        const athletesCol = collection(db, "athletes");
        onSnapshot(athletesCol, (snapshot) => {
            let html = "";
            let count = 0;
            snapshot.forEach(doc => {
                count++;
                const d = doc.data();
                html += `
                    <tr>
                        <td>${d.passport || '-'}</td>
                        <td>${d.name}</td>
                        <td>${d.age}</td>
                        <td>${d.gender}</td>
                        <td>${d.category}</td>
                        <td>${d.yearLevel}</td>
                        <td>${d.sport}</td>
                        <td>${d.division}</td>
                        <td>${d.weight}</td>
                        <td>${d.height}</td>
                        <td>${d.birthdate}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="window.deleteItem('athletes', '${doc.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('athleteTableBody').innerHTML = html;
            document.getElementById('stat-total-athletes').innerText = count;
        });

        // --- 2. AWARDS ---
        const awardsCol = collection(db, "awards");
        onSnapshot(awardsCol, (snapshot) => {
            let html = "";
            snapshot.forEach(doc => {
                const d = doc.data();
                html += `
                    <tr>
                        <td>${d.athleteName}</td>
                        <td>${d.division}</td>
                        <td>${d.event}</td>
                        <td>${d.medal}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 4px 8px;" onclick="window.deleteItem('awards', '${doc.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('awardTableBody').innerHTML = html;
        });

        // --- 3. PROTESTS (Notification Logic Here) ---
        const protestsCol = query(collection(db, "protests"), orderBy("timestamp", "desc"));
        onSnapshot(protestsCol, (snapshot) => {
            let html = "";
            let pendingCount = 0;
            let resolvedCount = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // Count Pending for Notification
                if(d.status === 'Pending') pendingCount++;
                if(d.status === 'Resolved') resolvedCount++;

                const statusColor = d.status === 'Resolved' ? 'color: green; font-weight:bold;' : 'color: red;';
                
                // Determine Action Button (Only show "Resolve" if pending)
                let actionBtn = "";
                if(d.status !== 'Resolved') {
                    actionBtn = `<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="window.openResolveModal('${doc.id}')">Resolve</button>`;
                } else {
                    actionBtn = `<i class="fas fa-check-circle" style="color: green;"></i> Done`;
                }

                html += `
                    <tr>
                        <td>${d.protester}</td>
                        <td>${d.respondent}</td>
                        <td>${d.description}</td>
                        <td>${d.resolution || '-'}</td>
                        <td>${d.settlement || '-'}</td>
                        <td style="${statusColor}">${d.status}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });

            document.getElementById('protestTableBody').innerHTML = html;
            document.getElementById('stat-pending-protests').innerText = pendingCount;
            document.getElementById('stat-resolved-protests').innerText = resolvedCount;

            // Update Notification Bell
            const badge = document.getElementById('notifBadge');
            if (pendingCount > 0) {
                badge.style.display = 'block';
                badge.innerText = pendingCount;
            } else {
                badge.style.display = 'none';
            }
        });

        // --- PROTEST RESOLUTION LOGIC ---
        const resolveModal = document.getElementById('resolveModal');
        const resolveForm = document.getElementById('resolveForm');

        window.openResolveModal = (id) => {
            document.getElementById('protestIdToResolve').value = id;
            resolveModal.style.display = 'block';
        };

        window.closeModal = () => {
            resolveModal.style.display = 'none';
            resolveForm.reset();
        };

        resolveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('protestIdToResolve').value;
            const resolution = document.getElementById('resDecision').value;
            const settlement = document.getElementById('resSettlement').value;

            try {
                const protestRef = doc(db, "protests", id);
                await updateDoc(protestRef, {
                    resolution: resolution,
                    settlement: settlement,
                    status: 'Resolved',
                    resolvedAt: new Date()
                });
                alert("Protest Resolved! Tabulation team will be notified.");
                window.closeModal();
            } catch (error) {
                console.error("Error resolving:", error);
                alert("Error: " + error.message);
            }
        });

        // --- FILTER LOGIC (Client Side) ---
        window.filterAthletes = () => {
            const nameFilter = document.getElementById('filterName').value.toUpperCase();
            const divFilter = document.getElementById('filterDivision').value.toUpperCase();
            const catFilter = document.getElementById('filterCategory').value.toUpperCase();
            const yearFilter = document.getElementById('filterYear').value.toUpperCase();

            const table = document.getElementById('athleteTableBody');
            const tr = table.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                const tds = tr[i].getElementsByTagName('td');
                if (tds.length > 0) {
                    const nameTxt = tds[1].textContent || tds[1].innerText;
                    const catTxt = tds[4].textContent || tds[4].innerText;
                    const yearTxt = tds[5].textContent || tds[5].innerText;
                    const divTxt = tds[7].textContent || tds[7].innerText;

                    if (
                        nameTxt.toUpperCase().indexOf(nameFilter) > -1 &&
                        (divFilter === "" || divTxt.toUpperCase() === divFilter) &&
                        (catFilter === "" || catTxt.toUpperCase() === catFilter) &&
                        (yearFilter === "" || yearTxt.toUpperCase() === yearFilter)
                    ) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        };

        // --- UTILS ---
        window.deleteItem = async (col, id) => {
            if(confirm("Delete this record permanently?")) {
                await deleteDoc(doc(db, col, id));
            }
        };

        window.exportTableToExcel = (tableId) => {
            let table = document.getElementById(tableId);
            let rows = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length - 1; j++) row.push(cols[j].innerText);
                rows.push(row.join(","));
            }
            let csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "r1aa_data.csv");
            document.body.appendChild(link);
            link.click();
        };

    </script>
</body>
</html>
