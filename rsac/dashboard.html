<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSAC Dashboard | R1AA System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- 1. CSS STYLES --- */
        :root {
            --primary: #0056b3;
            --dark: #1e293b;
            --light: #f1f5f9;
            --white: #ffffff;
            --gray: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); }

        /* Layout */
        .dashboard-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: var(--white); display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid #334155; display: flex; gap: 10px; align-items: center; }
        .brand i { color: #fdd835; }
        .nav-links { flex: 1; padding-top: 20px; }
        .nav-links a { display: flex; gap: 15px; padding: 15px 25px; color: #cbd5e1; text-decoration: none; transition: 0.2s; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { background: #334155; color: var(--white); border-left: 4px solid var(--primary); }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; } /* Hide all sections by default */
        .section.active { display: block; } /* Show active section */

        /* Controls (Search/Filter/Buttons) */
        .controls-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .controls-bar input, .controls-bar select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; display: flex; gap: 8px; align-items: center; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-action { padding: 6px 12px; font-size: 0.8rem; }

        /* Tables */
        .table-container { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f8fafc; color: var(--gray); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }

        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card h3 { color: var(--gray); font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card p { font-size: 2rem; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 24px; cursor: pointer; }

        /* Print Specifics */
        @media print {
            .sidebar, .controls-bar, .btn, .modal { display: none !important; }
            .dashboard-container { display: block; }
            .main-content { padding: 0; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-id-card-alt"></i>
                <span>RSAC Panel</span>
            </div>
            <nav class="nav-links">
                <a onclick="showSection('dashboard')" class="active" id="nav-dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a onclick="showSection('athletes')" id="nav-athletes"><i class="fas fa-running"></i> List of Athletes</a>
                <a onclick="showSection('awards')" id="nav-awards"><i class="fas fa-medal"></i> Athletes Award</a>
                <a onclick="showSection('protests')" id="nav-protests"><i class="fas fa-gavel"></i> Protest</a>
                <a id="logoutBtn" style="margin-top: auto; border-top: 1px solid #334155;"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            
            <div id="dashboard" class="section active">
                <h2>Real-Time Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: var(--primary);">
                        <h3>Total Athletes</h3>
                        <p id="stat-total-athletes">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <h3>Verified Documents</h3>
                        <p id="stat-verified">0</p>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger);">
                        <h3>Active Protests</h3>
                        <p id="stat-protests">0</p>
                    </div>
                </div>
            </div>

            <div id="athletes" class="section">
                <h2>List of Athletes</h2>
                
                <div class="controls-bar">
                    <input type="text" id="searchAthlete" placeholder="Search Name/Passport...">
                    <select id="filterDivision"><option value="">All Divisions</option></select>
                    <select id="filterCategory"><option value="">All Categories</option><option>Elementary</option><option>Secondary</option></select>
                    <button class="btn btn-primary" onclick="openAthleteModal()">+ Add Athlete</button>
                    <button class="btn btn-success" onclick="exportTableToExcel('athleteTable')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                </div>

                <div class="table-container">
                    <table id="athleteTable">
                        <thead>
                            <tr>
                                <th>Passport No.</th>
                                <th>Name</th>
                                <th>Division</th>
                                <th>Sport</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="athleteTableBody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="awards" class="section">
                <h2>Athletes Award</h2>
                <div class="controls-bar">
                    <input type="text" id="searchAward" placeholder="Search Winner Name...">
                    <button class="btn btn-primary" onclick="openAwardModal()">+ Add Award</button>
                    <button class="btn btn-success" onclick="exportTableToExcel('awardTable')"><i class="fas fa-file-excel"></i> Excel</button>
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                </div>
                <div class="table-container">
                    <table id="awardTable">
                        <thead>
                            <tr>
                                <th>Athlete Name</th>
                                <th>Event Joined</th>
                                <th>Medal Received</th>
                                <th>Division</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="awardTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="protests" class="section">
                <h2>Protest Management</h2>
                <div class="controls-bar">
                    <button class="btn btn-danger" onclick="openProtestModal()">+ File New Protest</button>
                </div>
                <div class="table-container">
                    <table id="protestTable">
                        <thead>
                            <tr>
                                <th>Protester</th>
                                <th>Protestee</th>
                                <th>Description</th>
                                <th>Status/Resolution</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="protestTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="athleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Athlete Details</h3>
                <span class="close" onclick="closeModals()">&times;</span>
            </div>
            <form id="athleteForm">
                <input type="hidden" id="athleteId"> <div class="form-grid">
                    <div class="form-group"><label>Passport Number</label><input type="text" id="inpPassport" required></div>
                    <div class="form-group"><label>Full Name</label><input type="text" id="inpName" required></div>
                    <div class="form-group"><label>Birthdate</label><input type="date" id="inpBday" required></div>
                    <div class="form-group"><label>Age</label><input type="number" id="inpAge" required></div>
                    <div class="form-group"><label>Gender</label><select id="inpGender"><option>Male</option><option>Female</option></select></div>
                    <div class="form-group"><label>Weight (kg)</label><input type="number" id="inpWeight"></div>
                    <div class="form-group"><label>Height (cm)</label><input type="number" id="inpHeight"></div>
                    <div class="form-group"><label>School Division</label><input type="text" id="inpDivision" placeholder="e.g. Ilocos Norte"></div>
                    <div class="form-group"><label>Category</label><select id="inpCategory"><option>Elementary</option><option>Secondary</option></select></div>
                    <div class="form-group"><label>Year Level</label><input type="text" id="inpYearLevel"></div>
                    <div class="form-group full-width"><label>Sports Event</label><input type="text" id="inpSport" placeholder="e.g. Basketball Boys"></div>
                </div>
                <br>
                <button type="submit" class="btn btn-primary full-width">Save Athlete</button>
            </form>
        </div>
    </div>

    <div id="awardModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h3>Record Award</h3>
            <form id="awardForm">
                <input type="hidden" id="awardId">
                <div class="form-group"><label>Athlete Name</label><input type="text" id="awardName" required></div>
                <div class="form-group"><label>Event Joined</label><input type="text" id="awardEvent" required></div>
                <div class="form-group"><label>Medal Received</label>
                    <select id="awardMedal">
                        <option>Gold</option>
                        <option>Silver</option>
                        <option>Bronze</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px;">Save Award</button>
            </form>
        </div>
    </div>

    <div id="protestModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h3>File Protest</h3>
            <form id="protestForm">
                <input type="hidden" id="protestId">
                <div class="form-grid">
                    <div class="form-group"><label>Protester (Complainant)</label><input type="text" id="protProtester" required></div>
                    <div class="form-group"><label>Protestee (Accused)</label><input type="text" id="protProtestee" required></div>
                    <div class="form-group full-width"><label>Protest Description</label><textarea id="protDesc" rows="3" required></textarea></div>
                    <div class="form-group full-width"><label>Resolution</label><textarea id="protRes" rows="2"></textarea></div>
                    <div class="form-group full-width"><label>Settlement/Agreement</label><textarea id="protSet" rows="2"></textarea></div>
                </div>
                <br>
                <button type="submit" class="btn btn-danger full-width">Save Protest Record</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURATION (Replace with yours)
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NAVIGATION LOGIC ---
        window.showSection = (sectionId) => {
            // Hide all
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(sectionId).classList.add('active');
            document.getElementById('nav-' + sectionId).classList.add('active');
        };

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
            } else {
                loadData(); // Load all tables
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });

        // --- DATA LOADING ---
        async function loadData() {
            loadAthletes();
            loadAwards();
            loadProtests();
        }

        // 1. ATHLETES CRUD
        const athleteForm = document.getElementById('athleteForm');
        async function loadAthletes() {
            const tbody = document.getElementById('athleteTableBody');
            tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            try {
                const querySnapshot = await getDocs(collection(db, "athletes"));
                let html = "";
                let count = 0;
                querySnapshot.forEach((doc) => {
                    count++;
                    const data = doc.data();
                    html += `
                        <tr>
                            <td>${data.passport || '-'}</td>
                            <td>${data.name}</td>
                            <td>${data.division}</td>
                            <td>${data.sport}</td>
                            <td>${data.category}</td>
                            <td>
                                <button class="btn btn-action btn-danger" onclick="window.deleteItem('athletes', '${doc.id}')">Delete</button>
                            </td>
                        </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="6">No athletes found.</td></tr>';
                document.getElementById('stat-total-athletes').innerText = count;
            } catch (e) { console.error(e); }
        }

        athleteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                passport: document.getElementById('inpPassport').value,
                name: document.getElementById('inpName').value,
                birthdate: document.getElementById('inpBday').value,
                age: document.getElementById('inpAge').value,
                gender: document.getElementById('inpGender').value,
                weight: document.getElementById('inpWeight').value,
                height: document.getElementById('inpHeight').value,
                division: document.getElementById('inpDivision').value,
                category: document.getElementById('inpCategory').value,
                yearLevel: document.getElementById('inpYearLevel').value,
                sport: document.getElementById('inpSport').value
            };
            
            await addDoc(collection(db, "athletes"), data);
            alert("Athlete Added!");
            closeModals();
            loadAthletes();
        });

        // 2. AWARDS CRUD
        const awardForm = document.getElementById('awardForm');
        async function loadAwards() {
            const tbody = document.getElementById('awardTableBody');
            const q = await getDocs(collection(db, "awards"));
            let html = "";
            q.forEach((doc) => {
                const d = doc.data();
                html += `<tr><td>${d.athleteName}</td><td>${d.event}</td><td>${d.medal}</td><td>-</td><td><button class="btn btn-action btn-danger" onclick="window.deleteItem('awards','${doc.id}')">Delete</button></td></tr>`;
            });
            tbody.innerHTML = html;
        }

        awardForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "awards"), {
                athleteName: document.getElementById('awardName').value,
                event: document.getElementById('awardEvent').value,
                medal: document.getElementById('awardMedal').value
            });
            alert("Award Saved!");
            closeModals();
            loadAwards();
        });

        // 3. PROTESTS CRUD
        const protestForm = document.getElementById('protestForm');
        async function loadProtests() {
            const tbody = document.getElementById('protestTableBody');
            const q = await getDocs(collection(db, "protests"));
            let html = "";
            let count = 0;
            q.forEach((doc) => {
                count++;
                const d = doc.data();
                html += `<tr><td>${d.protester}</td><td>${d.protestee}</td><td>${d.description}</td><td>${d.resolution}</td><td><button class="btn btn-action btn-danger" onclick="window.deleteItem('protests','${doc.id}')">Delete</button></td></tr>`;
            });
            tbody.innerHTML = html;
            document.getElementById('stat-protests').innerText = count;
        }

        protestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "protests"), {
                protester: document.getElementById('protProtester').value,
                protestee: document.getElementById('protProtestee').value,
                description: document.getElementById('protDesc').value,
                resolution: document.getElementById('protRes').value,
                settlement: document.getElementById('protSet').value
            });
            alert("Protest Filed!");
            closeModals();
            loadProtests();
        });

        // --- UTILITIES ---
        window.deleteItem = async (col, id) => {
            if(confirm("Are you sure?")) {
                await deleteDoc(doc(db, col, id));
                loadData();
            }
        };

        window.openAthleteModal = () => document.getElementById('athleteModal').style.display = 'block';
        window.openAwardModal = () => document.getElementById('awardModal').style.display = 'block';
        window.openProtestModal = () => document.getElementById('protestModal').style.display = 'block';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

        // EXCEL EXPORT FUNCTION
        window.exportTableToExcel = (tableId) => {
            let table = document.getElementById(tableId);
            let rows = [];
            
            // Iterate rows
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length - 1; j++) { // Skip "Actions" column
                    row.push(cols[j].innerText);
                }
                rows.push(row.join(","));
            }
            
            // Create CSV blob
            let csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "r1aa_data.csv"); // Saves as CSV which opens in Excel
            document.body.appendChild(link);
            link.click();
        };

        // SEARCH FILTER LOGIC (Simple Client Side)
        document.getElementById('searchAthlete').addEventListener('keyup', function() {
            let filter = this.value.toUpperCase();
            let rows = document.getElementById('athleteTableBody').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                let txtValue = rows[i].textContent || rows[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        });

    </script>
</body>
</html>
