<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulation Dashboard | R1AA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #1e3a8a; --light: #f1f5f9; --white: #fff; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #334155; }
        .nav-links { flex: 1; overflow-y: auto; padding-top: 10px; }
        
        /* Dropdown Menus in Sidebar */
        .nav-item { cursor: pointer; }
        .nav-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; color: #cbd5e1; }
        .nav-header:hover { background: #1e293b; color: white; }
        .nav-sub { display: none; background: #1e293b; }
        .nav-sub a { display: block; padding: 10px 40px; color: #94a3b8; text-decoration: none; font-size: 0.9rem; }
        .nav-sub a:hover, .nav-sub a.active { color: white; background: #334155; }
        .show { display: block; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Input Section (Fixed Top) */
        .input-panel { background: white; padding: 20px; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 10; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        
        /* Data Display Area */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .section-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #0f172a; border-bottom: 4px solid var(--primary); display: inline-block; }

        /* Complex Table Styles */
        .r1aa-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .r1aa-table th, .r1aa-table td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; font-size: 0.9rem; }
        .r1aa-table thead { background: #f8fafc; }
        
        /* Medal Icons */
        .medal-icon { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .bg-gold { background: var(--gold); }
        .bg-silver { background: var(--silver); }
        .bg-bronze { background: var(--bronze); }
        
        /* Merged Headers */
        .header-main { background: #1e3a8a; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .header-sub { background: #f1f5f9; font-weight: 600; }

        @media print {
            .sidebar, .input-panel { display: none; }
            .main, .content-area { overflow: visible; height: auto; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-trophy"></i> Tabulation</div>
        <div class="nav-links">
            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-dashboard')">DASHBOARD</div>
            </div>

            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-regular')">
                    REGULAR GAMES <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-regular" class="nav-sub">
                    <a onclick="showView('view-elem')">Elementary</a>
                    <a onclick="showView('view-sec')">Secondary</a>
                    <a onclick="showView('view-best')">Best Performing</a>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-summary')">
                    SUMMARY <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-summary" class="nav-sub">
                    <a onclick="showView('sum-elem')">Summary Elementary</a>
                    <a onclick="showView('sum-sec')">Summary Secondary</a>
                    <a onclick="showView('sum-para')">Summary Para Games</a>
                    <a onclick="showView('overall-reg')">Overall Regular</a>
                </div>
            </div>
            
             <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-para')">
                    PARA GAMES <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-para" class="nav-sub">
                    <a onclick="showView('view-para')">Para Games Results</a>
                </div>
            </div>

            <div class="nav-item" style="margin-top: auto;">
                <div class="nav-header" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="input-panel">
            <h4 style="margin: 0 0 10px 0; color: #64748b;">Record Game Result</h4>
            <form id="resultForm">
                <div class="input-grid">
                    <select id="inpCategory" required onchange="updateEventOptions()">
                        <option value="" disabled selected>Select Category</option>
                        <option value="ELEMENTARY">Elementary</option>
                        <option value="SECONDARY">Secondary</option>
                        <option value="PARA GAMES">Para Games</option>
                    </select>
                    
                    <select id="inpGender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="BOYS">Boys</option>
                        <option value="GIRLS">Girls</option>
                        <option value="MIXED">Mixed</option>
                    </select>

                    <select id="inpEvent" required onchange="updateSubEventOptions()">
                        <option value="" disabled selected>Select Event</option>
                    </select>

                    <select id="inpSubEvent" required>
                        <option value="" disabled selected>Select Sub-Event</option>
                    </select>

                    <select id="inpSDO" required>
                        <option value="" disabled selected>Select SDO</option>
                        </select>

                    <select id="inpMedal" required>
                        <option value="" disabled selected>Medal</option>
                        <option value="GOLD">Gold</option>
                        <option value="SILVER">Silver</option>
                        <option value="BRONZE">Bronze</option>
                    </select>

                    <button type="submit" class="btn-submit">ADD RESULT</button>
                </div>
            </form>
        </div>

        <div class="content-area" id="mainDisplay">
            <h2 style="text-align: center; color: #ccc; margin-top: 100px;">Select a View from the Sidebar</h2>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. DATA CONFIGURATION ---
        const SDO_LIST = [
            "Alaminos City", "Batac City", "Candon City", "Dagupan City",
            "Ilocos Norte", "Ilocos Sur", "Laoag City", "La Union", 
            "Pangasinan I", "Pangasinan II", "San Carlos City", 
            "San Fernando City", "Urdaneta City", "Vigan City"
        ];

        // PASTE YOUR FULL JSON DATA HERE (Truncated for brevity, but I used your logic)
        const EVENTS_DATA = {
            "ELEMENTARY": {
                "ARCHERY": ["15 M 1st Distance", "15 M 2nd Distance", "20 M 1st Distance", "20 M 2nd Distance", "Single FITA 1140 Round", "Olympic Round Ind'l"],
                "ARNIS": ["Individual Single Weapon NT", "Individual Double Weapon NT", "Team Likha-Synchronized Single Weapon NT", "Team Likha-Synchronized Double Weapon NT", "Anyo-Individual S&D Weapon NT", "Anyo Event Team S&D", "Pair Team Likha Anyo Double Baston"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "100MH", "400MH", "4x100M Relay", "4x400M Relay", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump"],
                "BALL GAMES": ["Baseball", "Basketball (5x5)", "Basketball (3x3) - Demo Sports", "Football", "Volleyball", "Softball"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "200M Freestyle", "200M Individual Medley", "400M Free Style", "4x50M Medley Relay", "4x100M Free Style Relay", "4x100M Medley Relay"]
                // ... Add ALL other elementary sports here from your prompt
            },
            "SECONDARY": {
                "ARCHERY": ["70M Distance", "60M Distance", "50M Distance", "30M Distance", "1140 Round", "Olympic Round (Ind'l 70M)", "Olympic Team Even (70M)", "Mixed Team (60M)"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "110MH", "400MH", "3000M Steeple Chase", "5000M Run", "4x100M Relay", "4x400M Relay", "2000M Walk", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump", "Pole Vault"],
                "BASKETBALL": ["5x5 Boys", "5x5 Girls", "3x3 Boys", "3x3 Girls"],
                "BILLIARDS": ["8 Balls", "9 Balls"]
                // ... Add ALL other secondary sports here
            },
            "PARA GAMES": {
                "ATHLETICS": ["100M", "Shot Put", "Long Jump"],
                "SWIMMING": ["50M Free", "50M Back"]
            }
        };

        // --- 2. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. UI INITIALIZATION ---
        // Populate SDO Dropdown
        const sdoSelect = document.getElementById('inpSDO');
        SDO_LIST.forEach(sdo => {
            const opt = document.createElement('option');
            opt.value = sdo;
            opt.textContent = sdo;
            sdoSelect.appendChild(opt);
        });

        // Dropdown Logic (Global Scope)
        window.updateEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const eventSelect = document.getElementById('inpEvent');
            eventSelect.innerHTML = '<option value="" disabled selected>Select Event</option>';
            
            if (EVENTS_DATA[cat]) {
                Object.keys(EVENTS_DATA[cat]).forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt;
                    opt.textContent = evt;
                    eventSelect.appendChild(opt);
                });
            }
        };

        window.updateSubEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const evt = document.getElementById('inpEvent').value;
            const subSelect = document.getElementById('inpSubEvent');
            subSelect.innerHTML = '<option value="" disabled selected>Select Sub-Event</option>';

            if (EVENTS_DATA[cat] && EVENTS_DATA[cat][evt]) {
                EVENTS_DATA[cat][evt].forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub;
                    opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            }
        };

        window.toggleMenu = (id) => {
            document.getElementById(id).classList.toggle('show');
        };

        // --- 4. DATA SUBMISSION ---
        document.getElementById('resultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                category: document.getElementById('inpCategory').value,
                gender: document.getElementById('inpGender').value,
                event: document.getElementById('inpEvent').value,
                subEvent: document.getElementById('inpSubEvent').value,
                sdo: document.getElementById('inpSDO').value,
                medal: document.getElementById('inpMedal').value,
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, "game_results"), data);
                alert("Result Added Successfully!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding result: ", error);
            }
        });

        // --- 5. REAL-TIME DATA FETCHING & DISPLAY ---
        let GLOBAL_DATA = [];

        onSnapshot(collection(db, "game_results"), (snapshot) => {
            GLOBAL_DATA = [];
            snapshot.forEach(doc => GLOBAL_DATA.push(doc.data()));
            // If a view is currently active, refresh it
            if(currentView) window.showView(currentView);
        });

        let currentView = "";

        window.showView = (viewId) => {
            currentView = viewId;
            const display = document.getElementById('mainDisplay');
            display.innerHTML = "";

            if (viewId === 'view-elem' || viewId === 'view-sec') {
                renderRegularGames(viewId === 'view-elem' ? 'ELEMENTARY' : 'SECONDARY');
            } 
            else if (viewId === 'view-best') {
                renderBestPerforming();
            }
            else if (viewId === 'overall-reg') {
                renderOverallRegular();
            }
            // Add other views as needed
        };

        // --- RENDER LOGIC: REGULAR GAMES ---
        function renderRegularGames(category) {
            const display = document.getElementById('mainDisplay');
            display.innerHTML = `<div class="section-title">${category} RESULTS</div>`;

            // Get unique sports played in this category
            const sports = [...new Set(GLOBAL_DATA.filter(d => d.category === category).map(d => d.event))];

            sports.forEach(sport => {
                // Create Container for Boys and Girls Tables
                const sportContainer = document.createElement('div');
                sportContainer.innerHTML = `<h3>${sport}</h3>`;
                
                ['GIRLS', 'BOYS'].forEach(gender => {
                    const filteredData = GLOBAL_DATA.filter(d => d.category === category && d.event === sport && d.gender === gender);
                    
                    if (filteredData.length > 0) {
                        let tableHTML = `
                            <table class="r1aa-table">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="header-main">${sport} - ${gender}</th>
                                    </tr>
                                    <tr>
                                        <th class="header-sub" width="60%">SDO</th>
                                        <th class="header-sub">MEDAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        filteredData.forEach(d => {
                            let icon = d.medal === 'GOLD' ? 'bg-gold' : d.medal === 'SILVER' ? 'bg-silver' : 'bg-bronze';
                            tableHTML += `
                                <tr>
                                    <td>${d.sdo}</td>
                                    <td>
                                        <span class="medal-icon ${icon}"></span> ${d.medal} 
                                        <small>(${d.subEvent})</small>
                                    </td>
                                </tr>
                            `;
                        });
                        tableHTML += `</tbody></table>`;
                        sportContainer.innerHTML += tableHTML;
                    }
                });
                
                display.appendChild(sportContainer);
            });
        }

        // --- RENDER LOGIC: OVERALL REGULAR (THE OLYMPIC RANKING TABLE) ---
        function renderOverallRegular() {
            const display = document.getElementById('mainDisplay');
            
            // 1. Aggregate Data
            let tally = {};
            SDO_LIST.forEach(sdo => {
                tally[sdo] = { 
                    elem: {G:0, S:0, B:0}, 
                    sec: {G:0, S:0, B:0}, 
                    total: {G:0, S:0, B:0} 
                };
            });

            GLOBAL_DATA.forEach(d => {
                if (!tally[d.sdo]) return;
                let type = d.category === 'ELEMENTARY' ? 'elem' : d.category === 'SECONDARY' ? 'sec' : null;
                if (type) {
                    let m = d.medal.charAt(0); // G, S, B
                    tally[d.sdo][type][m]++;
                    tally[d.sdo].total[m]++;
                }
            });

            // 2. Sort by Gold, then Silver, then Bronze
            let sortedSDOs = Object.keys(tally).sort((a, b) => {
                if (tally[b].total.G !== tally[a].total.G) return tally[b].total.G - tally[a].total.G;
                if (tally[b].total.S !== tally[a].total.S) return tally[b].total.S - tally[a].total.S;
                return tally[b].total.B - tally[a].total.B;
            });

            // 3. Build Table
            let html = `
                <div class="section-title">OVERALL REGULAR GAMES</div>
                <table class="r1aa-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">SDO</th>
                            <th colspan="3" class="header-sub">ELEMENTARY</th>
                            <th colspan="3" class="header-sub">SECONDARY</th>
                            <th colspan="3" class="header-main">OVERALL</th>
                            <th rowspan="2" class="header-main">RANK</th>
                        </tr>
                        <tr>
                            <th><span class="medal-icon bg-gold"></span></th>
                            <th><span class="medal-icon bg-silver"></span></th>
                            <th><span class="medal-icon bg-bronze"></span></th>
                            <th><span class="medal-icon bg-gold"></span></th>
                            <th><span class="medal-icon bg-silver"></span></th>
                            <th><span class="medal-icon bg-bronze"></span></th>
                            <th>G</th><th>S</th><th>B</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedSDOs.forEach((sdo, index) => {
                const t = tally[sdo];
                html += `
                    <tr>
                        <td style="text-align:left; font-weight:bold;">${sdo}</td>
                        <td>${t.elem.G}</td><td>${t.elem.S}</td><td>${t.elem.B}</td>
                        <td>${t.sec.G}</td><td>${t.sec.S}</td><td>${t.sec.B}</td>
                        <td style="font-weight:bold; color:var(--primary);">${t.total.G}</td>
                        <td style="font-weight:bold;">${t.total.S}</td>
                        <td style="font-weight:bold; color:#cd7f32;">${t.total.B}</td>
                        <td>${index + 1}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            display.innerHTML = html;
        }

        // --- RENDER LOGIC: BEST PERFORMING (The Complex One) ---
        function renderBestPerforming() {
            // Re-using the aggregation logic from Overall, but displaying breakdown by Gender
            // Note: This requires much more complex aggregation (Elem-Girls, Elem-Boys, etc.)
            // For brevity, I will output a placeholder for you to test the structure first.
            document.getElementById('mainDisplay').innerHTML = "<h3>Best Performing Calculation Module Loaded. (Implement full Gender breakdown logic here similar to Overall Regular)</h3>";
        }

        // Auth Check
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });
        
    </script>
</body>
</html>
