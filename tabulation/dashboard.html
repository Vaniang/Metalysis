<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulation Dashboard | R1AA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #1e3a8a; --light: #f1f5f9; --white: #fff; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --success: #22c55e; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #334155; }
        .nav-links { flex: 1; overflow-y: auto; padding-top: 10px; }
        
        /* Sidebar Menus */
        .nav-item { cursor: pointer; }
        .nav-header { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: #cbd5e1; font-weight: 600; font-size: 0.9rem; border-left: 3px solid transparent; }
        .nav-header:hover { background: #1e293b; color: white; }
        .nav-sub { display: none; background: #1e293b; }
        .nav-sub a { display: block; padding: 8px 15px 8px 45px; color: #94a3b8; text-decoration: none; font-size: 0.85rem; border-left: 3px solid transparent; }
        .nav-sub a:hover, .nav-sub a.active { color: white; background: #334155; border-left-color: var(--primary); }
        .show { display: block; }
        
        /* Scrollbar for sidebar */
        .nav-links::-webkit-scrollbar { width: 6px; }
        .nav-links::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Input Section */
        .input-panel { background: white; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9rem; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-submit:hover { background: #1e40af; }
        
        /* Data Display Area */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .section-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #0f172a; border-bottom: 4px solid var(--primary); display: inline-block; padding-bottom: 5px; }

        /* Matrix Table Styles */
        .table-wrapper { margin-bottom: 40px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .table-header-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
        .tool-btn { background: none; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #64748b; font-size: 0.85rem; margin-left: 5px; transition: 0.2s; }
        .tool-btn:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }
        .tool-btn i { margin-right: 5px; }

        .r1aa-table { width: 100%; border-collapse: collapse; font-family: 'Segoe UI', sans-serif; }
        .r1aa-table th, .r1aa-table td { border: 1px solid #94a3b8; padding: 6px; text-align: center; font-size: 0.8rem; }
        .r1aa-table thead th { background: #f8fafc; color: #334155; font-weight: 700; }
        .r1aa-table tbody tr:hover { background-color: #f8fafc; }
        
        /* Specific Column Widths for Matrix */
        .col-sdo { text-align: left !important; font-weight: 600; min-width: 150px; background: #fff; }
        .header-sub-event { background: #e2e8f0 !important; font-size: 0.75rem; text-transform: uppercase; }
        .cell-medal { width: 30px; }
        .header-total { background: #334155 !important; color: white !important; }

        @media print {
            .sidebar, .input-panel, .tool-btn, .nav-links { display: none !important; }
            .main, .content-area { overflow: visible; height: auto; display: block; }
            .table-wrapper { box-shadow: none; break-inside: avoid; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-trophy"></i> Tabulation</div>
        <div class="nav-links" id="sidebarNav">
            <div style="padding:20px; text-align:center; color:#64748b;">Loading Events...</div>
        </div>
        <div style="margin-top: auto; border-top: 1px solid #334155;">
            <div class="nav-item">
                <div class="nav-header" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="input-panel">
            <h4 style="margin: 0 0 10px 0; color: #64748b; font-size: 0.9rem;">Record Game Result</h4>
            <form id="resultForm">
                <div class="input-grid">
                    <select id="inpCategory" required onchange="updateEventOptions()">
                        <option value="" disabled selected>Category</option>
                        <option value="ELEMENTARY">Elementary</option>
                        <option value="SECONDARY">Secondary</option>
                        <option value="PARA GAMES">Para Games</option>
                    </select>
                    <select id="inpGender" required>
                        <option value="" disabled selected>Gender</option>
                        <option value="BOYS">Boys</option>
                        <option value="GIRLS">Girls</option>
                        <option value="MIXED">Mixed</option>
                    </select>
                    <select id="inpEvent" required onchange="updateSubEventOptions()">
                        <option value="" disabled selected>Event</option>
                    </select>
                    <select id="inpSubEvent" required>
                        <option value="" disabled selected>Sub-Event</option>
                    </select>
                    <select id="inpSDO" required>
                        <option value="" disabled selected>SDO</option>
                    </select>
                    <select id="inpMedal" required>
                        <option value="" disabled selected>Medal</option>
                        <option value="GOLD">Gold</option>
                        <option value="SILVER">Silver</option>
                        <option value="BRONZE">Bronze</option>
                    </select>
                    <button type="submit" class="btn-submit">ADD</button>
                </div>
            </form>
        </div>

        <div class="content-area" id="mainDisplay">
            <div style="text-align: center; color: #94a3b8; margin-top: 100px;">
                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h3>Select a Sport from the Sidebar</h3>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. DATA CONFIGURATION ---
        const SDO_LIST = [
            "Alaminos City", "Batac City", "Candon City", "Dagupan City",
            "Ilocos Norte", "Ilocos Sur", "Laoag City", "La Union", 
            "Pangasinan I", "Pangasinan II", "San Carlos City", 
            "San Fernando City", "Urdaneta City", "Vigan City"
        ];

        // FULL DATA OBJECT (Shortened for brevity, but includes the structure)
        const EVENTS_DATA = {
            "ELEMENTARY": {
                "ARCHERY": ["15 M 1st Distance", "15 M 2nd Distance", "20 M 1st Distance", "20 M 2nd Distance", "Single FITA 1140 Round", "Olympic Round Ind'l"],
                "ARNIS": ["Individual Single Weapon NT", "Individual Double Weapon NT", "Team Likha-Synchronized Single Weapon NT", "Team Likha-Synchronized Double Weapon NT", "Anyo-Individual S&D Weapon NT", "Anyo Event Team S&D", "Pair Team Likha Anyo Double Baston"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "100MH", "400MH", "4x100M Relay", "4x400M Relay", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump"],
                "BALL GAMES": ["Baseball", "Basketball (5x5)", "Basketball (3x3) - Demo Sports", "Football", "Volleyball", "Softball"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "200M Freestyle", "200M Individual Medley", "400M Free Style", "4x50M Medley Relay", "4x100M Free Style Relay", "4x100M Medley Relay"],
                "TAEKWONDO - KYORUGI": ["Over 144cm to 150cm", "Over 152cm to 158cm", "Over 160cm", "Group A â€“ Individual"],
                "TAEKWONDO - POOMSAE": ["Group A - Individual", "Group B - Individual", "Team - Event", "Mix Pair"]
            },
            "SECONDARY": {
                "ARCHERY": ["70M Distance", "60M Distance", "50M Distance", "30M Distance", "1140 Round", "Olympic Round (Ind'l 70M)", "Olympic Team Even (70M)", "Mixed Team (60M)"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "110MH", "400MH", "3000M Steeple Chase", "5000M Run", "4x100M Relay", "4x400M Relay", "2000M Walk", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump", "Pole Vault"],
                "BASKETBALL": ["5x5 Boys", "5x5 Girls", "3x3 Boys", "3x3 Girls"],
                "BILLIARDS": ["8 Balls", "9 Balls"]
            },
            "PARA GAMES": {
                "ATHLETICS": ["100M", "Shot Put", "Long Jump"],
                "SWIMMING": ["50M Free", "50M Back"]
            }
        };

        // --- 2. FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. DYNAMIC SIDEBAR GENERATION ---
        function renderSidebar() {
            const nav = document.getElementById('sidebarNav');
            nav.innerHTML = `
                <div class="nav-item">
                    <div class="nav-header" onclick="window.location.reload()">DASHBOARD</div>
                </div>
            `;

            // Regular Games (Elementary & Secondary)
            ['ELEMENTARY', 'SECONDARY'].forEach(cat => {
                let html = `
                    <div class="nav-item">
                        <div class="nav-header" onclick="toggleMenu('menu-${cat}')">
                            ${cat} <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="menu-${cat}" class="nav-sub">
                `;
                
                // Sort sports alphabetically
                const sports = Object.keys(EVENTS_DATA[cat]).sort();
                sports.forEach(sport => {
                    html += `<a onclick="showSportView('${cat}', '${sport}')">${sport}</a>`;
                });

                html += `</div></div>`;
                nav.innerHTML += html;
            });

            // Para Games
            nav.innerHTML += `
                <div class="nav-item">
                    <div class="nav-header" onclick="toggleMenu('menu-PARA')">
                        PARA GAMES <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="menu-PARA" class="nav-sub">
                        <a onclick="showSportView('PARA GAMES', 'ATHLETICS')">ATHLETICS</a>
                        <a onclick="showSportView('PARA GAMES', 'SWIMMING')">SWIMMING</a>
                    </div>
                </div>
            `;

            // Summary
            nav.innerHTML += `
                 <div class="nav-item">
                    <div class="nav-header" onclick="toggleMenu('menu-SUMMARY')">
                        SUMMARY <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="menu-SUMMARY" class="nav-sub">
                        <a onclick="renderOverallRegular()">OVERALL REGULAR</a>
                        <a onclick="alert('Coming Soon')">BEST PERFORMING</a>
                    </div>
                </div>
            `;
        }
        
        // Execute Sidebar Render
        renderSidebar();

        // --- 4. FORM LOGIC ---
        const sdoSelect = document.getElementById('inpSDO');
        SDO_LIST.forEach(sdo => {
            const opt = document.createElement('option');
            opt.value = sdo;
            opt.textContent = sdo;
            sdoSelect.appendChild(opt);
        });

        window.updateEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const eventSelect = document.getElementById('inpEvent');
            eventSelect.innerHTML = '<option value="" disabled selected>Event</option>';
            document.getElementById('inpSubEvent').innerHTML = '<option value="" disabled selected>Sub-Event</option>';

            if (EVENTS_DATA[cat]) {
                Object.keys(EVENTS_DATA[cat]).sort().forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt;
                    opt.textContent = evt;
                    eventSelect.appendChild(opt);
                });
            }
        };

        window.updateSubEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const evt = document.getElementById('inpEvent').value;
            const subSelect = document.getElementById('inpSubEvent');
            subSelect.innerHTML = '<option value="" disabled selected>Sub-Event</option>';

            if (EVENTS_DATA[cat] && EVENTS_DATA[cat][evt]) {
                const subs = EVENTS_DATA[cat][evt];
                subs.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub;
                    opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            }
        };

        window.toggleMenu = (id) => {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('show');
        };

        // --- 5. DATA HANDLING ---
        document.getElementById('resultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cat = document.getElementById('inpCategory').value;
            const gen = document.getElementById('inpGender').value;
            const evt = document.getElementById('inpEvent').value;
            const sub = document.getElementById('inpSubEvent').value;
            const sdo = document.getElementById('inpSDO').value;
            const medal = document.getElementById('inpMedal').value;

            if(!cat || !gen || !evt || !sub || !sdo || !medal) return;

            try {
                await addDoc(collection(db, "game_results"), {
                    category: cat, gender: gen, event: evt, subEvent: sub, sdo: sdo, medal: medal, timestamp: new Date()
                });
                alert("Saved!");
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        let GLOBAL_DATA = [];
        let CURRENT_VIEW = { type: null, cat: null, sport: null };

        onSnapshot(collection(db, "game_results"), (snapshot) => {
            GLOBAL_DATA = [];
            snapshot.forEach(doc => GLOBAL_DATA.push(doc.data()));
            // Refresh current view if open
            if(CURRENT_VIEW.type === 'sport') window.showSportView(CURRENT_VIEW.cat, CURRENT_VIEW.sport);
            if(CURRENT_VIEW.type === 'overall') window.renderOverallRegular();
        });

        // --- 6. RENDER LOGIC: SPORT SCORE SHEET (MATRIX) ---
        window.showSportView = (category, sport) => {
            CURRENT_VIEW = { type: 'sport', cat: category, sport: sport };
            const display = document.getElementById('mainDisplay');
            display.innerHTML = `<div class="section-title">${category} - ${sport}</div>`;

            // Get Sub-Events for columns
            const subEvents = EVENTS_DATA[category][sport] || ["Result"];

            ['BOYS', 'GIRLS'].forEach(gender => {
                const tableId = `tbl-${category}-${sport}-${gender}`.replace(/\s+/g, '');
                
                let tableHTML = `
                    <div class="table-wrapper">
                        <div class="table-header-tools">
                            <h3 style="margin:0;">${gender} Division</h3>
                            <div>
                                <button class="tool-btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                                <button class="tool-btn" onclick="window.exportToExcel('${tableId}')"><i class="fas fa-file-excel"></i> Excel</button>
                            </div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="${tableId}" class="r1aa-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="col-sdo">EVENT / DELEGATION</th>
                                        ${subEvents.map(sub => `<th colspan="3" class="header-sub-event">${sub}</th>`).join('')}
                                        <th colspan="3" class="header-total">TOTAL</th>
                                    </tr>
                                    <tr>
                                        ${subEvents.map(() => `<th>G</th><th>S</th><th>B</th>`).join('')}
                                        <th style="background:#e2e8f0;">G</th><th style="background:#e2e8f0;">S</th><th style="background:#e2e8f0;">B</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Rows (SDOs)
                SDO_LIST.forEach(sdo => {
                    let rG = 0, rS = 0, rB = 0;
                    let rowHTML = `<tr><td class="col-sdo">${sdo}</td>`;

                    subEvents.forEach(sub => {
                        let cG = 0, cS = 0, cB = 0;
                        const hits = GLOBAL_DATA.filter(d => 
                            d.category === category && d.event === sport && d.gender === gender && d.subEvent === sub && d.sdo === sdo
                        );
                        hits.forEach(h => {
                            if(h.medal === 'GOLD') cG++;
                            if(h.medal === 'SILVER') cS++;
                            if(h.medal === 'BRONZE') cB++;
                        });
                        
                        rG += cG; rS += cS; rB += cB;

                        // Cells
                        rowHTML += `<td>${cG||''}</td><td>${cS||''}</td><td style="border-right:2px solid #ccc;">${cB||''}</td>`;
                    });

                    // Row Total
                    rowHTML += `<td style="font-weight:bold; background:#f8fafc;">${rG||''}</td>
                                <td style="font-weight:bold; background:#f8fafc;">${rS||''}</td>
                                <td style="font-weight:bold; background:#f8fafc;">${rB||''}</td></tr>`;
                    
                    tableHTML += rowHTML;
                });

                tableHTML += `</tbody></table></div></div>`;
                display.innerHTML += tableHTML;
            });
        };

        // --- 7. EXPORT FUNCTION ---
        window.exportToExcel = (tableId) => {
            const table = document.getElementById(tableId);
            if(!table) return;
            
            let rows = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                rows.push(row.join(","));
            }
            
            const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `R1AA_Result_${tableId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 8. RENDER OVERALL ---
        window.renderOverallRegular = () => {
            CURRENT_VIEW = { type: 'overall' };
            const display = document.getElementById('mainDisplay');
            
            // Calculation
            let tally = {};
            SDO_LIST.forEach(sdo => tally[sdo] = { elem: {G:0,S:0,B:0}, sec: {G:0,S:0,B:0}, total: {G:0,S:0,B:0} });

            GLOBAL_DATA.forEach(d => {
                if (!tally[d.sdo]) return;
                let type = d.category === 'ELEMENTARY' ? 'elem' : d.category === 'SECONDARY' ? 'sec' : null;
                if (type) {
                    let m = d.medal.charAt(0);
                    tally[d.sdo][type][m]++;
                    tally[d.sdo].total[m]++;
                }
            });

            let sorted = Object.keys(tally).sort((a, b) => {
                if (tally[b].total.G !== tally[a].total.G) return tally[b].total.G - tally[a].total.G;
                return tally[b].total.S - tally[a].total.S;
            });

            let html = `
                <div class="section-title">OVERALL REGULAR GAMES</div>
                <div class="table-wrapper">
                    <div class="table-header-tools">
                        <h3>Medal Tally</h3>
                        <button class="tool-btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                    </div>
                    <table class="r1aa-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-sdo">SDO</th>
                                <th colspan="3" class="header-total">TOTAL</th>
                            </tr>
                            <tr><th>G</th><th>S</th><th>B</th></tr>
                        </thead>
                        <tbody>
            `;
            
            sorted.forEach(sdo => {
                html += `<tr>
                    <td class="col-sdo">${sdo}</td>
                    <td style="font-weight:bold; color:#1e3a8a;">${tally[sdo].total.G}</td>
                    <td>${tally[sdo].total.S}</td>
                    <td style="color:#cd7f32;">${tally[sdo].total.B}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            display.innerHTML = html;
        };

        // Auth
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "../index.html";
        });

    </script>
</body>
</html>
