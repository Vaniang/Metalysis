<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulation Dashboard | R1AA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- CSS STYLES --- */
        :root { 
            --primary: #1e3a8a; --secondary: #3b82f6; --accent: #f59e0b;
            --light: #f8fafc; --white: #ffffff; --dark: #0f172a;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #334155; }

        /* Sidebar (Made slightly smaller to save space) */
        .sidebar { width: 260px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; z-index: 20; }
        .brand { padding: 25px 20px; font-size: 1.2rem; font-weight: 700; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--accent); }
        .nav-links { flex: 1; overflow-y: auto; padding-top: 10px; }
        
        /* Sidebar Menus */
        .nav-item { cursor: pointer; }
        .nav-header { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: #94a3b8; font-weight: 600; font-size: 0.85rem; border-left: 3px solid transparent; transition: 0.2s; }
        .nav-header:hover { background: #1e293b; color: white; }
        .nav-sub { display: none; background: #020617; }
        .nav-sub a { display: block; padding: 8px 15px 8px 45px; color: #64748b; text-decoration: none; font-size: 0.75rem; border-left: 3px solid transparent; transition: 0.2s; border-bottom: 1px solid #1e293b; }
        .nav-sub a:hover, .nav-sub a.active { color: white; background: #1e293b; border-left-color: var(--accent); }
        .show { display: block; }

        .nav-links::-webkit-scrollbar { width: 6px; }
        .nav-links::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* Input Panel */
        .input-panel { background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; backdrop-filter: blur(5px); }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.85rem; background: #fff; }
        .btn-submit { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: transform 0.1s; }
        .btn-submit:active { transform: scale(0.98); }
        
        /* Content Area */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; background: #f1f5f9; }
        .section-title { font-size: 1.6rem; font-weight: 800; margin-bottom: 25px; color: var(--dark); border-bottom: 4px solid var(--accent); display: inline-block; padding-bottom: 5px; }

        /* Dashboard Widgets */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid var(--primary); }
        .stat-info p { margin: 5px 0 0 0; font-size: 1.6rem; font-weight: 800; color: var(--dark); }
        
        /* Charts */
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 350px; position: relative; }
        
        /* Matrix Tables (Score Sheet Style) */
        .table-wrapper { 
            background: white; 
            padding: 25px; 
            border-radius: 4px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            margin-bottom: 40px; 
            border: 1px solid #cbd5e1;
            overflow-x: auto; 
        }
        
        .table-header-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .tool-btn { background: white; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #475569; font-size: 0.8rem; margin-left: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

        /* --- FIXED TABLE SPACING --- */
        .r1aa-table { 
            width: max-content; /* Shrinks table to fit content (Removes huge gap) */
            min-width: 50%;
            border-collapse: collapse; 
            border-spacing: 0; 
            font-family: 'Arial', sans-serif; 
        }
        .r1aa-table th, .r1aa-table td { border: 1px solid #475569; padding: 8px 10px; text-align: center; font-size: 0.8rem; }
        .r1aa-table thead th { background: #e2e8f0; color: #000; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; }
        
        /* Sticky First Column - TIGHTER WIDTH */
        .col-sdo { 
            text-align: left !important; 
            font-weight: 700; 
            background: #fff; 
            position: sticky; 
            left: 0; 
            /* Changed from fixed 250px to auto with min/max constraints */
            width: auto;
            min-width: 160px; /* Just enough for 'San Fernando City' */
            max-width: 200px;
            white-space: nowrap; /* Prevents wrapping */
            border-right: 2px solid #000 !important; 
            z-index: 5;
        }
        
        .header-total { border-left: 2px solid #000 !important; }
        .cell-total { border-left: 2px solid #000 !important; font-weight: bold; background-color: #f1f5f9; }

        /* Print */
        @media print {
            .sidebar, .input-panel, .tool-btn, .nav-links { display: none !important; }
            .main, .content-area { overflow: visible; height: auto; display: block; padding: 0; background: white; }
            .charts-container, .dashboard-grid { display: none; }
            .table-wrapper { box-shadow: none; border: none; padding: 0; page-break-inside: avoid; }
            .r1aa-table { width: 100%; } 
            .r1aa-table th, .r1aa-table td { border: 1px solid #000 !important; }
        }
        @media (max-width: 1024px) { .charts-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-medal"></i> R1AA Tabulation</div>
        <div class="nav-links" id="sidebarNav">
            <div style="padding:20px; text-align:center; opacity: 0.6;">Loading Events...</div>
        </div>
        <div style="margin-top: auto; padding: 20px; border-top: 1px solid #1e293b;">
            <div style="display:flex; align-items:center; cursor:pointer; color:#94a3b8;" id="logoutBtn">
                <i class="fas fa-sign-out-alt" style="margin-right:10px;"></i> Sign Out
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="input-panel">
            <h4 style="margin: 0 0 8px 0; color: #64748b; font-size: 0.75rem; text-transform:uppercase; letter-spacing:1px;">Record Game Result</h4>
            <form id="resultForm">
                <div class="input-grid">
                    <select id="inpCategory" required onchange="updateEventOptions()">
                        <option value="" disabled selected>Category</option>
                        <option value="ELEMENTARY">Elementary</option>
                        <option value="SECONDARY">Secondary</option>
                        <option value="PARA GAMES">Para Games</option>
                    </select>
                    <select id="inpGender" required>
                        <option value="" disabled selected>Gender</option>
                        <option value="BOYS">Boys</option>
                        <option value="GIRLS">Girls</option>
                        <option value="MIXED">Mixed</option>
                    </select>
                    <select id="inpEvent" required onchange="updateSubEventOptions()">
                        <option value="" disabled selected>Event</option>
                    </select>
                    <select id="inpSubEvent" required>
                        <option value="" disabled selected>Sub-Event</option>
                    </select>
                    <select id="inpSDO" required>
                        <option value="" disabled selected>SDO</option>
                    </select>
                    <select id="inpMedal" required>
                        <option value="" disabled selected>Medal</option>
                        <option value="GOLD">Gold</option>
                        <option value="SILVER">Silver</option>
                        <option value="BRONZE">Bronze</option>
                    </select>
                    <button type="submit" class="btn-submit">ADD RECORD</button>
                </div>
            </form>
        </div>

        <div class="content-area" id="mainDisplay"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. DATA CONFIGURATION ---
        const SDO_LIST = [
            "Alaminos City", "Batac City", "Candon City", "Dagupan City", "Ilocos Norte", "Ilocos Sur", 
            "Laoag City", "La Union", "Pangasinan I", "Pangasinan II", "San Carlos City", 
            "San Fernando City", "Urdaneta City", "Vigan City"
        ];

        const EVENTS_DATA = {
            "ELEMENTARY": {
                // Regular Sports
                "ARNIS": ["Individual Single Weapon NT", "Individual Double Weapon NT", "Team Likha-Synchronized Single Weapon NT", "Team Likha-Synchronized Double Weapon NT", "Anyo-Individual S&D Weapon NT", "Anyo Event Team S&D", "Pair Team Likha Anyo Double Baston"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "100MH", "400MH", "4x100M Relay", "4x400M Relay", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump"],
                "BADMINTON": ["Singles", "Doubles", "Mixed"],
                "BASEBALL (BOYS)": ["Team"],
                "BASKETBALL (BOYS)": ["Team"],
                "CHESS": ["Standard - Individual", "Standard - Team", "Rapid - Individual", "Rapid - Team", "Blitz - Individual", "Blitz – Team"],
                "DANCESPORTS": ["Chacha", "Samba", "Rumba", "Pasadoble", "Jive", "Grade A - C, S, R, P, D, J", "Waltz", "Tango", "V-Waltz", "Foxtrot", "Quickstep", "Grade A - W, T, VW, SF, Q"],
                "FOOTBALL (BOYS)": ["Team"],
                "GYMNASTICS - AERO": ["Individual Men", "Individual Women", "Trio", "Mix Pair", "Aero Dance", "Team"],
                "GYMNASTICS - MAG": ["Floor Exercise", "Vaulting Table", "Mushroom", "Individual Around", "Horizontal Bar"],
                "GYMNASTICS - WAG": ["Floor Exercise", "Balance Beam", "Vault", "Single Bar", "Individual All Around", "Team"],
                "GYMNASTICS - RG": ["Ball", "Rope", "Hoop", "Free Hand", "Individual All Around", "Team"],
                "SEPAK TAKRAW JR.": ["Junior - Team", "Double Takraw"],
                "SOFTBALL (GIRLS)": ["Team"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "200M Freestyle", "200M Individual Medley", "400M Free Style", "4x50M Medley Relay", "4x100M Free Style Relay", "4x100M Medley Relay"],
                "TABLE TENNIS": ["Singles", "Doubles", "Mixed Doubles"],
                "TAEKWONDO": ["Over 144cm to 150cm", "Over 152cm to 158cm", "Over 160cm", "Group A – Individual", "Group A - Individual", "Group B - Individual", "Team - Event", "Mix Pair"],
                "TENNIS": ["Singles", "Doubles"],
                "VOLLEYBALL": ["Team"],
                
                // Demonstration Sports
                "ARCHERY (DEMO)": ["15 M 1st Distance", "15 M 2nd Distance", "20 M 1st Distance", "20 M 2nd Distance", "Single FITA 1140 Round", "Olympic Round Ind'l"],
                "BASKETBALL 3x3 (BOYS) (DEMO)": ["Team"],
                "BASKETBALL 5x5 (GIRLS) (DEMO)": ["Team"]
            },
            "SECONDARY": {
                "ARCHERY": ["70M Distance", "60M Distance", "50M Distance", "30M Distance", "1140 Round", "Olympic Round (Ind'l 70M)", "Olympic Team Even (70M)", "Mixed Team (60M)"],
                "ARNIS": ["Ind’l Solo Baston (Single Weapon)", "Ind’l Doble Baston (Double Weapon)", "Team (Synd)-Solo Baston (Single Weapon)", "Team (Synd)-Double Baston (Double Weapon)", "EVENT Individual Espada Y Daga", "EVENT Team Espada Y Daga", "Pin Weight (43kg up to 47kg)", "Bantam-Weight (47kg up to 51kg)", "Feather-Weight (51kg up to 55kg)", "Extra Light Weight (55kg up to 60kg)", "Half Light Weight (60kg up to 65kg)"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "110MH", "400MH", "3000M Steeple Chase", "5000M Run", "4x100M Relay", "4x400M Relay", "2000M Walk", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump", "Pole Vault"],
                "BALL GAMES": ["Baseball", "Basketball (5x5)", "Basketball (3x3)", "Football", "Volleyball", "Futsal", "Softball"],
                "SEPAK TAKRAW": ["Best Regu", "Team"],
                "RACKET GAMES - BADMINTON": ["Singles", "Doubles", "Mixed"],
                "RACKET GAMES - TABLE TENNIS": ["Singles", "Doubles", "Mixed Doubles"],
                "RACKET GAMES - TENNIS": ["Singles", "Doubles"],
                "BILLIARDS": ["8 Balls", "9 Balls"],
                "CHESS": ["Standard - Individual", "Standard - Team", "Rapid - Individual", "Rapid - Team", "Blitz - Individual", "Blitz – Team"],
                "PENCAK SILAT - COMBAT": ["Class A Over 42kg up to 45kg", "Class B Over 45kg up to 48kg", "Class C Over 48kg up to 51kg", "Class D Over 51kg up to 54kg", "Class E Over 54kg up to 57kg"],
                "PENCAK SILAT - DEMO": ["Tunggal-Ind'l Weapon", "Ganda-Double Weapon", "Regu-Team Artistic"],
                "GYMNASTICS - MAG CLUSTER 3": ["Floor Exercise", "Vaulting Table", "Mushroom", "Individual All Around", "Horizontal Bar", "Team"],
                "GYMNASTICS - WAG CLUSTER 3": ["Floor Exercise", "Balance Beam", "Vault", "Individual All Around", "Single Bar", "Team"],
                "GYMNASTICS - RG": ["Ball", "Club", "Ribbon", "Hoop", "Individual All Around", "Team"],
                "BOXING": ["Pin Weight (SB)", "Pin Weight (JB)", "Light Flyweight (SB)", "Light Flyweight (jB)", "Flyweight (JB)", "Light Bantam Weight (JB)", "Bantam Weight (JB)", "Minimum Weight (YB)", "Flyweight (YB)", "Bantam Weight (YB)"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "100M Butterfly", "200M Backstroke", "200M Breaststroke", "200M Freestyle", "200M Butterfly", "400M Free Style", "800M Freestyle", "1500M Freestyle", "200M Individual Medley", "400M Individual Medley", "200M Freestyle Relay", "200M Medley Relay", "400M Freestyle Relay", "400M Medley Relay"],
                "TAEKWONDO - KYORUGI": ["Fin Weight", "Fly Weight", "Bantam Weight", "Feather Weight", "Light Weight", "Welter Weight", "LT Middle Weight"],
                "TAEKWONDO - POOMSAE": ["Group A - Individual", "Group B - Individual", "Team - Event", "Mix Pair"],
                "Wushu Boys (Group A)": ["48kgs", "52kgs", "56kgs"],
                "Wushu Boys (Group B)": ["42kgs", "45kgs", "48kgs"],
                "Wrestling": ["Cadet 42kgs", "Cadet 46kgs", "Cadet 50kgs", "Cadet 54kgs", "Junior 54kgs", "Junior 58kgs", "Junior 62kgs", "Junior 66kgs"]
            },
            "PARA GAMES": {
                "ATHLETICS": ["100M", "Shot Put", "Long Jump"],
                "SWIMMING": ["50M Free", "50M Back"]
            }
        };

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE & SIDEBAR ---
        let GLOBAL_DATA = [];
        let CURRENT_VIEW = 'dashboard';
        let CHART_INSTANCES = [];

        function renderSidebar() {
            const nav = document.getElementById('sidebarNav');
            nav.innerHTML = `
                <div class="nav-item">
                    <div class="nav-header" onclick="renderDashboard()">
                        <span><i class="fas fa-home" style="margin-right:8px;"></i> DASHBOARD</span>
                    </div>
                </div>
            `;

            ['ELEMENTARY', 'SECONDARY'].forEach(cat => {
                let html = `
                    <div class="nav-item">
                        <div class="nav-header" onclick="toggleMenu('menu-${cat}')">
                            <span><i class="fas fa-layer-group" style="margin-right:8px;"></i> ${cat}</span>
                            <i class="fas fa-chevron-down" style="font-size:0.7rem;"></i>
                        </div>
                        <div id="menu-${cat}" class="nav-sub">`;
                
                Object.keys(EVENTS_DATA[cat]).sort().forEach(sport => {
                    html += `<a onclick="renderSportMatrix('${cat}', '${sport}')">${sport}</a>`;
                });

                html += `</div></div>`;
                nav.innerHTML += html;
            });

            // Para & Summary
            nav.innerHTML += `
                <div class="nav-item">
                    <div class="nav-header" onclick="toggleMenu('menu-PARA')">
                        <span><i class="fas fa-wheelchair" style="margin-right:8px;"></i> PARA GAMES</span>
                        <i class="fas fa-chevron-down" style="font-size:0.7rem;"></i>
                    </div>
                    <div id="menu-PARA" class="nav-sub">
                        <a onclick="renderSportMatrix('PARA GAMES', 'ATHLETICS')">ATHLETICS</a>
                        <a onclick="renderSportMatrix('PARA GAMES', 'SWIMMING')">SWIMMING</a>
                    </div>
                </div>
                <div class="nav-item">
                    <div class="nav-header" onclick="toggleMenu('menu-SUMMARY')">
                        <span><i class="fas fa-chart-pie" style="margin-right:8px;"></i> SUMMARY</span>
                        <i class="fas fa-chevron-down" style="font-size:0.7rem;"></i>
                    </div>
                    <div id="menu-SUMMARY" class="nav-sub">
                        <a onclick="renderOverallRegular()">OVERALL REGULAR</a>
                    </div>
                </div>
            `;
        }
        renderSidebar();

        // --- FORM HELPERS ---
        const sdoSelect = document.getElementById('inpSDO');
        SDO_LIST.forEach(sdo => {
            const opt = document.createElement('option');
            opt.value = sdo; opt.textContent = sdo; sdoSelect.appendChild(opt);
        });

        window.updateEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const eventSelect = document.getElementById('inpEvent');
            eventSelect.innerHTML = '<option value="" disabled selected>Event</option>';
            document.getElementById('inpSubEvent').innerHTML = '<option value="" disabled selected>Sub-Event</option>';
            if (EVENTS_DATA[cat]) {
                Object.keys(EVENTS_DATA[cat]).sort().forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt; opt.textContent = evt; eventSelect.appendChild(opt);
                });
            }
        };

        window.updateSubEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const evt = document.getElementById('inpEvent').value;
            const subSelect = document.getElementById('inpSubEvent');
            subSelect.innerHTML = '<option value="" disabled selected>Sub-Event</option>';
            if (EVENTS_DATA[cat] && EVENTS_DATA[cat][evt]) {
                EVENTS_DATA[cat][evt].forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub; opt.textContent = sub; subSelect.appendChild(opt);
                });
            }
        };

        window.toggleMenu = (id) => document.getElementById(id).classList.toggle('show');

        // --- ADD DATA ---
        document.getElementById('resultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = document.getElementById('resultForm');
            if(!form.checkValidity()) { form.reportValidity(); return; }

            try {
                const data = {
                    category: document.getElementById('inpCategory').value,
                    gender: document.getElementById('inpGender').value,
                    event: document.getElementById('inpEvent').value,
                    subEvent: document.getElementById('inpSubEvent').value,
                    sdo: document.getElementById('inpSDO').value,
                    medal: document.getElementById('inpMedal').value,
                    timestamp: new Date()
                };
                await addDoc(collection(db, "game_results"), data);
                alert("Record Added!");
            } catch (err) { alert("Error: " + err.message); }
        });

        // --- DATA LISTENER ---
        onSnapshot(collection(db, "game_results"), (snapshot) => {
            GLOBAL_DATA = [];
            snapshot.forEach(doc => GLOBAL_DATA.push(doc.data()));
            
            if(CURRENT_VIEW === 'dashboard') renderDashboard();
            else if(CURRENT_VIEW.type === 'sport') renderSportMatrix(CURRENT_VIEW.cat, CURRENT_VIEW.sport);
            else if(CURRENT_VIEW === 'overall') renderOverallRegular();
        });

        // --- DASHBOARD (CHARTS) ---
        window.renderDashboard = () => {
            CURRENT_VIEW = 'dashboard';
            const display = document.getElementById('mainDisplay');
            
            const totalMedals = GLOBAL_DATA.length;
            const totalElem = GLOBAL_DATA.filter(d => d.category === 'ELEMENTARY').length;
            const totalSec = GLOBAL_DATA.filter(d => d.category === 'SECONDARY').length;
            
            let counts = {};
            GLOBAL_DATA.forEach(d => {
                counts[d.sdo] = (counts[d.sdo] || 0) + (d.medal === 'GOLD' ? 5 : d.medal === 'SILVER' ? 3 : 1);
            });
            let topSDO = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, "No Data");

            display.innerHTML = `
                <div class="section-title">Dashboard Overview</div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-info"><p style="font-size:0.8rem;color:#64748b;margin-bottom:5px;">RESULTS POSTED</p><p>${totalMedals}</p></div>
                        <div style="font-size:2rem;color:var(--primary);"><i class="fas fa-clipboard-check"></i></div>
                    </div>
                    <div class="stat-card" style="border-left-color:var(--accent);">
                        <div class="stat-info"><p style="font-size:0.8rem;color:#64748b;margin-bottom:5px;">LEADING SDO</p><p style="font-size:1.3rem;">${topSDO}</p></div>
                        <div style="font-size:2rem;color:var(--accent);"><i class="fas fa-trophy"></i></div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-card">
                        <h4 style="margin:0 0 10px 0;color:#64748b;">Medal Tally by SDO</h4>
                        <canvas id="medalChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4 style="margin:0 0 10px 0;color:#64748b;">Category Breakdown</h4>
                        <canvas id="catChart"></canvas>
                    </div>
                </div>
            `;
            initCharts();
        };

        function initCharts() {
            CHART_INSTANCES.forEach(c => c.destroy());
            CHART_INSTANCES = [];

            let sdoLabels = SDO_LIST;
            let goldData = SDO_LIST.map(sdo => GLOBAL_DATA.filter(d => d.sdo === sdo && d.medal === 'GOLD').length);
            let silverData = SDO_LIST.map(sdo => GLOBAL_DATA.filter(d => d.sdo === sdo && d.medal === 'SILVER').length);
            let bronzeData = SDO_LIST.map(sdo => GLOBAL_DATA.filter(d => d.sdo === sdo && d.medal === 'BRONZE').length);

            const ctx1 = document.getElementById('medalChart').getContext('2d');
            CHART_INSTANCES.push(new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sdoLabels.map(s => s.replace(" City", "").replace("Pangasinan", "Pang")), 
                    datasets: [
                        { label: 'Gold', data: goldData, backgroundColor: '#fbbf24' },
                        { label: 'Silver', data: silverData, backgroundColor: '#94a3b8' },
                        { label: 'Bronze', data: bronzeData, backgroundColor: '#b45309' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            }));

            const ctx2 = document.getElementById('catChart').getContext('2d');
            let elemCount = GLOBAL_DATA.filter(d => d.category === 'ELEMENTARY').length;
            let secCount = GLOBAL_DATA.filter(d => d.category === 'SECONDARY').length;

            CHART_INSTANCES.push(new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Elementary', 'Secondary'],
                    datasets: [{ data: [elemCount, secCount], backgroundColor: ['#f97316', '#8b5cf6'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            }));
        }

        // --- 9. SPORT MATRIX RENDER (FIXED TITLE + FIXED SPACING) ---
        window.renderSportMatrix = (category, sport) => {
            CURRENT_VIEW = { type: 'sport', cat: category, sport: sport };
            const display = document.getElementById('mainDisplay');
            display.innerHTML = `<div class="section-title" style="text-transform:uppercase;">${category} - ${sport.replace("(DEMO)", " (DEMO)")}</div>`;

            const subEvents = EVENTS_DATA[category][sport] || ["Result"];

            // Logic to determine which gender tables to show
            let gendersToShow = ['BOYS', 'GIRLS'];
            if (sport.includes('(BOYS)') || sport.includes('MAG')) gendersToShow = ['BOYS'];
            if (sport.includes('(GIRLS)') || sport.includes('WAG') || sport.includes('RG')) gendersToShow = ['GIRLS'];

            gendersToShow.forEach(gender => {
                const tableId = `tbl-${category}-${sport}-${gender}`.replace(/[^a-zA-Z0-9]/g, '');
                
                // --- FIXED TITLE FORMATTING LOGIC ---
                let cleanSport = sport.replace("(DEMO)", "").trim();
                cleanSport = cleanSport.replace("(BOYS)", "").replace("(GIRLS)", "").trim();
                let tableTitle = `${cleanSport} - ${gender}`;
                if(sport.includes("(DEMO)")) tableTitle += " (DEMO)";

                let tableHTML = `
                    <div class="table-wrapper">
                        <div class="table-header-tools">
                            <h3 style="margin:0; font-size:1.2rem; color:#000; text-transform:uppercase; font-weight:800;">${tableTitle}</h3>
                            <div>
                                <button class="tool-btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                                <button class="tool-btn" onclick="window.exportToExcel('${tableId}')"><i class="fas fa-file-excel"></i> Excel</button>
                            </div>
                        </div>
                        <div style="overflow-x:auto;">
                            <table id="${tableId}" class="r1aa-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="col-sdo">EVENT / DELEGATION</th>
                                        ${subEvents.map(sub => `<th colspan="3" style="background:#e2e8f0; font-size:0.65rem;">${sub}</th>`).join('')}
                                        <th colspan="3" class="header-total" style="color:black; background:#e2e8f0;">TOTAL</th>
                                    </tr>
                                    <tr>
                                        ${subEvents.map(() => `<th style="width:25px;">G</th><th style="width:25px;">S</th><th style="width:25px;">B</th>`).join('')}
                                        <th style="width:30px; border-left:2px solid #000;">G</th>
                                        <th style="width:30px;">S</th>
                                        <th style="width:30px;">B</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                SDO_LIST.forEach(sdo => {
                    let rG = 0, rS = 0, rB = 0;
                    let rowHTML = `<tr><td class="col-sdo">${sdo}</td>`;
                    subEvents.forEach(sub => {
                        let cG=0, cS=0, cB=0;
                        GLOBAL_DATA.filter(d => d.category===category && d.event===sport && d.gender===gender && d.subEvent===sub && d.sdo===sdo)
                            .forEach(h => { if(h.medal==='GOLD')cG++; if(h.medal==='SILVER')cS++; if(h.medal==='BRONZE')cB++; });
                        rG+=cG; rS+=cS; rB+=cB;
                        rowHTML += `<td>${cG||''}</td><td>${cS||''}</td><td style="border-right:1px solid #475569;">${cB||''}</td>`;
                    });
                    rowHTML += `<td class="cell-total">${rG||''}</td>
                                <td style="font-weight:bold; background:#f1f5f9;">${rS||''}</td>
                                <td style="font-weight:bold; background:#f1f5f9;">${rB||''}</td></tr>`;
                    tableHTML += rowHTML;
                });
                tableHTML += `</tbody></table></div></div>`;
                display.innerHTML += tableHTML;
            });
        };

        // --- 10. OVERALL ---
        window.renderOverallRegular = () => {
            CURRENT_VIEW = 'overall';
            const display = document.getElementById('mainDisplay');
            let tally = {};
            SDO_LIST.forEach(sdo => tally[sdo] = { elem: {G:0,S:0,B:0}, sec: {G:0,S:0,B:0}, total: {G:0,S:0,B:0} });

            GLOBAL_DATA.forEach(d => {
                if (!tally[d.sdo]) return;
                let type = d.category === 'ELEMENTARY' ? 'elem' : d.category === 'SECONDARY' ? 'sec' : null;
                if (type) {
                    let m = d.medal.charAt(0);
                    tally[d.sdo][type][m]++;
                    tally[d.sdo].total[m]++;
                }
            });

            let sorted = Object.keys(tally).sort((a, b) => {
                if (tally[b].total.G !== tally[a].total.G) return tally[b].total.G - tally[a].total.G;
                return tally[b].total.S - tally[a].total.S;
            });

            let html = `
                <div class="section-title">OVERALL REGULAR GAMES</div>
                <div class="table-wrapper">
                    <div class="table-header-tools">
                        <h3>Medal Tally</h3>
                        <button class="tool-btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                    </div>
                    <table class="r1aa-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-sdo">SDO</th>
                                <th colspan="3" style="background:#e2e8f0;">ELEMENTARY</th>
                                <th colspan="3" style="background:#e2e8f0;">SECONDARY</th>
                                <th colspan="3" class="header-total" style="color:black; background:#e2e8f0;">OVERALL</th>
                                <th rowspan="2" class="header-total" style="color:black; background:#e2e8f0;">RANK</th>
                            </tr>
                            <tr>
                                <th>G</th><th>S</th><th>B</th>
                                <th>G</th><th>S</th><th>B</th>
                                <th style="border-left:2px solid #000;">G</th><th>S</th><th>B</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            sorted.forEach((sdo, idx) => {
                const t = tally[sdo];
                html += `<tr>
                    <td class="col-sdo">${sdo}</td>
                    <td>${t.elem.G}</td><td>${t.elem.S}</td><td>${t.elem.B}</td>
                    <td>${t.sec.G}</td><td>${t.sec.S}</td><td>${t.sec.B}</td>
                    <td class="cell-total">${t.total.G}</td>
                    <td style="font-weight:bold; background:#f1f5f9;">${t.total.S}</td>
                    <td style="font-weight:bold; background:#f1f5f9;">${t.total.B}</td>
                    <td style="font-weight:bold;">${idx+1}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            display.innerHTML = html;
        };

        // --- 11. EXPORT ---
        window.exportToExcel = (tableId) => {
            const table = document.getElementById(tableId);
            if(!table) return;
            let rows = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
                rows.push(row.join(","));
            }
            const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `R1AA_Result_${tableId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Auth
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "../index.html";
            else renderDashboard();
        });
    </script>
</body>
</html>
