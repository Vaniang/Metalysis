<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulation Dashboard | R1AA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #1e3a8a; --light: #f1f5f9; --white: #fff; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: #0f172a; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #334155; }
        .nav-links { flex: 1; overflow-y: auto; padding-top: 10px; }
        
        /* Dropdown Menus in Sidebar */
        .nav-item { cursor: pointer; }
        .nav-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; color: #cbd5e1; }
        .nav-header:hover { background: #1e293b; color: white; }
        .nav-sub { display: none; background: #1e293b; }
        .nav-sub a { display: block; padding: 10px 40px; color: #94a3b8; text-decoration: none; font-size: 0.9rem; }
        .nav-sub a:hover, .nav-sub a.active { color: white; background: #334155; }
        .show { display: block; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Input Section (Fixed Top) */
        .input-panel { background: white; padding: 20px; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); z-index: 10; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        
        /* Data Display Area */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .section-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #0f172a; border-bottom: 4px solid var(--primary); display: inline-block; }

        /* Complex Table Styles */
        .r1aa-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .r1aa-table th, .r1aa-table td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; font-size: 0.9rem; }
        .r1aa-table thead { background: #f8fafc; }
        
        /* Medal Icons */
        .medal-icon { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .bg-gold { background: var(--gold); }
        .bg-silver { background: var(--silver); }
        .bg-bronze { background: var(--bronze); }
        
        /* Merged Headers */
        .header-main { background: #1e3a8a; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .header-sub { background: #f1f5f9; font-weight: 600; }

        @media print {
            .sidebar, .input-panel { display: none; }
            .main, .content-area { overflow: visible; height: auto; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-trophy"></i> Tabulation</div>
        <div class="nav-links">
            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-dashboard')">DASHBOARD</div>
            </div>

            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-regular')">
                    REGULAR GAMES <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-regular" class="nav-sub">
                    <a onclick="showView('view-elem')">Elementary</a>
                    <a onclick="showView('view-sec')">Secondary</a>
                    <a onclick="showView('view-best')">Best Performing</a>
                </div>
            </div>

            <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-summary')">
                    SUMMARY <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-summary" class="nav-sub">
                    <a onclick="showView('sum-elem')">Summary Elementary</a>
                    <a onclick="showView('sum-sec')">Summary Secondary</a>
                    <a onclick="showView('sum-para')">Summary Para Games</a>
                    <a onclick="showView('overall-reg')">Overall Regular</a>
                </div>
            </div>
            
             <div class="nav-item">
                <div class="nav-header" onclick="toggleMenu('menu-para')">
                    PARA GAMES <i class="fas fa-chevron-down"></i>
                </div>
                <div id="menu-para" class="nav-sub">
                    <a onclick="showView('view-para')">Para Games Results</a>
                </div>
            </div>

            <div class="nav-item" style="margin-top: auto;">
                <div class="nav-header" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="input-panel">
            <h4 style="margin: 0 0 10px 0; color: #64748b;">Record Game Result</h4>
            <form id="resultForm">
                <div class="input-grid">
                    <select id="inpCategory" required onchange="updateEventOptions()">
                        <option value="" disabled selected>Select Category</option>
                        <option value="ELEMENTARY">Elementary</option>
                        <option value="SECONDARY">Secondary</option>
                        <option value="PARA GAMES">Para Games</option>
                    </select>
                    
                    <select id="inpGender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="BOYS">Boys</option>
                        <option value="GIRLS">Girls</option>
                        <option value="MIXED">Mixed</option>
                    </select>

                    <select id="inpEvent" required onchange="updateSubEventOptions()">
                        <option value="" disabled selected>Select Event</option>
                    </select>

                    <select id="inpSubEvent" required>
                        <option value="" disabled selected>Select Sub-Event</option>
                    </select>

                    <select id="inpSDO" required>
                        <option value="" disabled selected>Select SDO</option>
                        </select>

                    <select id="inpMedal" required>
                        <option value="" disabled selected>Medal</option>
                        <option value="GOLD">Gold</option>
                        <option value="SILVER">Silver</option>
                        <option value="BRONZE">Bronze</option>
                    </select>

                    <button type="submit" class="btn-submit">ADD RESULT</button>
                </div>
            </form>
        </div>

        <div class="content-area" id="mainDisplay">
            <h2 style="text-align: center; color: #ccc; margin-top: 100px;">Select a View from the Sidebar</h2>
        </div>
    </main>

   <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. DATA CONFIGURATION ---
        const SDO_LIST = [
            "Alaminos City", "Batac City", "Candon City", "Dagupan City",
            "Ilocos Norte", "Ilocos Sur", "Laoag City", "La Union", 
            "Pangasinan I", "Pangasinan II", "San Carlos City", 
            "San Fernando City", "Urdaneta City", "Vigan City"
        ];

        // ENSURE THIS MATCHES YOUR FULL LIST EXACTLY
        const EVENTS_DATA = {
            "ELEMENTARY": {
                "ARCHERY": ["15 M 1st Distance", "15 M 2nd Distance", "20 M 1st Distance", "20 M 2nd Distance", "Single FITA 1140 Round", "Olympic Round Ind'l"],
                "ARNIS": ["Individual Single Weapon NT", "Individual Double Weapon NT", "Team Likha-Synchronized Single Weapon NT", "Team Likha-Synchronized Double Weapon NT", "Anyo-Individual S&D Weapon NT", "Anyo Event Team S&D", "Pair Team Likha Anyo Double Baston"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "100MH", "400MH", "4x100M Relay", "4x400M Relay", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump"],
                "BALL GAMES": ["Baseball", "Basketball (5x5)", "Basketball (3x3) - Demo Sports", "Football", "Volleyball", "Softball"],
                "SEPAK TAKRAW": ["Junior - Team", "Double Takraw"],
                "CHESS": ["Standard - Individual", "Standard - Team", "Rapid - Individual", "Rapid - Team", "Blitz - Individual", "Blitz – Team"],
                "RACKET GAMES - BADMINTON": ["Singles", "Doubles", "Mixed"],
                "RACKET GAMES - TABLE TENNIS": ["Singles", "Doubles", "Mixed Doubles"],
                "RACKET GAMES - TENNIS": ["Singles", "Doubles"],
                "DANCE SPORTS - LATIN SINGLE DANCE": ["Chacha", "Samba", "Rumba", "Pasadoble", "Jive", "Grade A - C, S, R, P, D, J"],
                "DANCE SPORTS - MODERN STANDARD SINGLE DANCE": ["Waltz", "Tango", "V-Waltz", "Foxtrot", "Quickstep", "Grade A - W, T, VW, SF, Q"],
                "GYMNASTICS - MAG CLUSTER 1": ["Floor Exercise", "Vaulting Table", "Mushroom", "Individual Around", "Horizontal Bar"],
                "GYMNASTICS - MAG CLUSTER 2": ["Floor Exercise", "Vaulting Table", "Mushroom", "Individual Around", "Horizontal Bar"],
                "GYMNASTICS - WAG CLUSTER 1": ["Floor Exercise", "Balance Beam", "Vault", "Single Bar", "Individual All Around", "Team"],
                "GYMNASTICS - WAG CLUSTER 2": ["Floor Exercise", "Balance Beam", "Vault", "Single Bar", "Individual All Around", "Team"],
                "GYMNASTICS - RG": ["Ball", "Rope", "Hoop", "Free Hand", "Individual All Around", "Team"],
                "AEROGYMNASTICS": ["Individual Men", "Individual Women", "Trio", "Mix Pair", "Aero Dance", "Team"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "200M Freestyle", "200M Individual Medley", "400M Free Style", "4x50M Medley Relay", "4x100M Free Style Relay", "4x100M Medley Relay"],
                "TAEKWONDO - KYORUGI": ["Over 144cm to 150cm", "Over 152cm to 158cm", "Over 160cm", "Group A – Individual"],
                "TAEKWONDO - POOMSAE": ["Group A - Individual", "Group B - Individual", "Team - Event", "Mix Pair"]
            },
            "SECONDARY": {
                "ARCHERY": ["70M Distance", "60M Distance", "50M Distance", "30M Distance", "1140 Round", "Olympic Round (Ind'l 70M)", "Olympic Team Even (70M)", "Mixed Team (60M)"],
                "ARNIS": ["Ind’l Solo Baston (Single Weapon)", "Ind’l Doble Baston (Double Weapon)", "Team (Synd)-Solo Baston (Single Weapon)", "Team (Synd)-Double Baston (Double Weapon)", "EVENT Individual Espada Y Daga", "EVENT Team Espada Y Daga", "Pin Weight (43kg up to 47kg)", "Bantam-Weight (47kg up to 51kg)", "Feather-Weight (51kg up to 55kg)", "Extra Light Weight (55kg up to 60kg)", "Half Light Weight (60kg up to 65kg)"],
                "ATHLETICS": ["100M Dash", "200M Dash", "400M Dash", "800M Run", "1500M Run", "110MH", "400MH", "3000M Steeple Chase", "5000M Run", "4x100M Relay", "4x400M Relay", "2000M Walk", "Javelin Throw", "Discus Throw", "Shot Put", "High Jump", "Long Jump", "Triple Jump", "Pole Vault"],
                "BALL GAMES": ["Baseball", "Basketball (5x5)", "Basketball (3x3)", "Football", "Volleyball", "Futsal", "Softball"],
                "SEPAK TAKRAW": ["Best Regu", "Team"],
                "RACKET GAMES - BADMINTON": ["Singles", "Doubles", "Mixed"],
                "RACKET GAMES - TABLE TENNIS": ["Singles", "Doubles", "Mixed Doubles"],
                "RACKET GAMES - TENNIS": ["Singles", "Doubles"],
                "BILLIARDS": ["8 Balls", "9 Balls"],
                "CHESS": ["Standard - Individual", "Standard - Team", "Rapid - Individual", "Rapid - Team", "Blitz - Individual", "Blitz – Team"],
                "PENCAK SILAT - COMBAT": ["Class A Over 42kg up to 45kg", "Class B Over 45kg up to 48kg", "Class C Over 48kg up to 51kg", "Class D Over 51kg up to 54kg", "Class E Over 54kg up to 57kg"],
                "PENCAK SILAT - DEMO": ["Tunggal-Ind'l Weapon", "Ganda-Double Weapon", "Regu-Team Artistic"],
                "GYMNASTICS - MAG CLUSTER 3": ["Floor Exercise", "Vaulting Table", "Mushroom", "Individual All Around", "Horizontal Bar", "Team"],
                "GYMNASTICS - WAG CLUSTER 3": ["Floor Exercise", "Balance Beam", "Vault", "Individual All Around", "Single Bar", "Team"],
                "GYMNASTICS - RG": ["Ball", "Club", "Ribbon", "Hoop", "Individual All Around", "Team"],
                "BOXING": ["Pin Weight (SB)", "Pin Weight (JB)", "Light Flyweight (SB)", "Light Flyweight (jB)", "Flyweight (JB)", "Light Bantam Weight (JB)", "Bantam Weight (JB)", "Minimum Weight (YB)", "Flyweight (YB)", "Bantam Weight (YB)"],
                "SWIMMING": ["50M Back Stroke", "50M Breaststroke", "50M Butterfly", "50M Free Style", "100M Back Stroke", "100M Free Style", "100M Butterfly", "200M Backstroke", "200M Breaststroke", "200M Freestyle", "200M Butterfly", "400M Free Style", "800M Freestyle", "1500M Freestyle", "200M Individual Medley", "400M Individual Medley", "200M Freestyle Relay", "200M Medley Relay", "400M Freestyle Relay", "400M Medley Relay"],
                "TAEKWONDO - KYORUGI": ["Fin Weight", "Fly Weight", "Bantam Weight", "Feather Weight", "Light Weight", "Welter Weight", "LT Middle Weight"],
                "TAEKWONDO - POOMSAE": ["Group A - Individual", "Group B - Individual", "Team - Event", "Mix Pair"],
                "Wushu Boys (Group A)": ["48kgs", "52kgs", "56kgs"],
                "Wushu Boys (Group B)": ["42kgs", "45kgs", "48kgs"],
                "Wrestling": ["Cadet 42kgs", "Cadet 46kgs", "Cadet 50kgs", "Cadet 54kgs", "Junior 54kgs", "Junior 58kgs", "Junior 62kgs", "Junior 66kgs"]
            },
            "PARA GAMES": {
                "ATHLETICS": ["100M", "Shot Put", "Long Jump"],
                "SWIMMING": ["50M Free", "50M Back"]
            }
        };

        // --- 2. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfhfZ_c8wbTTviu4MrhvbRknqzyBkzI_s",
            authDomain: "metalysis-f38ef.firebaseapp.com",
            projectId: "metalysis-f38ef",
            storageBucket: "metalysis-f38ef.firebasestorage.app",
            messagingSenderId: "666983988939",
            appId: "1:666983988939:web:f70937a2572ed08015a54e",
            measurementId: "G-96ZPLMV4J7"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. UI INITIALIZATION ---
        // Populate SDO Dropdown
        const sdoSelect = document.getElementById('inpSDO');
        SDO_LIST.forEach(sdo => {
            const opt = document.createElement('option');
            opt.value = sdo;
            opt.textContent = sdo;
            sdoSelect.appendChild(opt);
        });

        // Dropdown Logic (Global Scope)
        window.updateEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const eventSelect = document.getElementById('inpEvent');
            eventSelect.innerHTML = '<option value="" disabled selected>Select Event</option>';
            document.getElementById('inpSubEvent').innerHTML = '<option value="" disabled selected>Select Sub-Event</option>';

            if (EVENTS_DATA[cat]) {
                Object.keys(EVENTS_DATA[cat]).forEach(evt => {
                    const opt = document.createElement('option');
                    opt.value = evt;
                    opt.textContent = evt;
                    eventSelect.appendChild(opt);
                });
            }
        };

        window.updateSubEventOptions = () => {
            const cat = document.getElementById('inpCategory').value;
            const evt = document.getElementById('inpEvent').value;
            const subSelect = document.getElementById('inpSubEvent');
            subSelect.innerHTML = '<option value="" disabled selected>Select Sub-Event</option>';

            if (EVENTS_DATA[cat] && EVENTS_DATA[cat][evt]) {
                const subEvents = EVENTS_DATA[cat][evt];
                if(subEvents.length > 0) {
                     subEvents.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub;
                        opt.textContent = sub;
                        subSelect.appendChild(opt);
                    });
                    subSelect.disabled = false; // Enable if options exist
                } else {
                    const opt = document.createElement('option');
                    opt.value = "N/A";
                    opt.textContent = "N/A";
                    opt.selected = true;
                    subSelect.appendChild(opt);
                }
            }
        };

        window.toggleMenu = (id) => {
            document.getElementById(id).classList.toggle('show');
        };

        // --- 4. DATA SUBMISSION ---
        document.getElementById('resultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cat = document.getElementById('inpCategory').value;
            const gen = document.getElementById('inpGender').value;
            const evt = document.getElementById('inpEvent').value;
            const sub = document.getElementById('inpSubEvent').value;
            const sdo = document.getElementById('inpSDO').value;
            const medal = document.getElementById('inpMedal').value;

            if(!cat || !gen || !evt || !sub || !sdo || !medal) {
                alert("Please fill all fields!");
                return;
            }

            const data = {
                category: cat,
                gender: gen,
                event: evt,
                subEvent: sub,
                sdo: sdo,
                medal: medal,
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, "game_results"), data);
                alert("Result Added Successfully!");
                // Don't reset everything, usually tabulation adds multiple for same event
                // e.target.reset(); 
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        // --- 5. REAL-TIME DATA FETCHING ---
        let GLOBAL_DATA = [];

        onSnapshot(collection(db, "game_results"), (snapshot) => {
            GLOBAL_DATA = [];
            snapshot.forEach(doc => GLOBAL_DATA.push(doc.data()));
            if(currentView) window.showView(currentView);
        });

        let currentView = "";

        window.showView = (viewId) => {
            currentView = viewId;
            const display = document.getElementById('mainDisplay');
            display.innerHTML = "";

            if (viewId === 'view-elem') renderRegularGames('ELEMENTARY');
            else if (viewId === 'view-sec') renderRegularGames('SECONDARY');
            else if (viewId === 'view-best') renderBestPerforming();
            else if (viewId === 'overall-reg') renderOverallRegular();
            else if (viewId === 'view-para') renderRegularGames('PARA GAMES');
            else display.innerHTML = `<h3>View: ${viewId} under construction</h3>`;
        };

        // --- RENDER: REGULAR GAMES (MATRIX STYLE) ---
        function renderRegularGames(category) {
            const display = document.getElementById('mainDisplay');
            display.innerHTML = `<div class="section-title">${category} RESULTS (SCORE SHEET)</div>`;

            // 1. Get List of Sports for this Category from EVENTS_DATA
            const sportsList = Object.keys(EVENTS_DATA[category]);

            sportsList.forEach(sport => {
                const subEvents = EVENTS_DATA[category][sport] || ["N/A"];
                
                ['BOYS', 'GIRLS'].forEach(gender => {
                    // Create Container
                    const container = document.createElement('div');
                    container.style.marginBottom = "40px";
                    
                    // --- BUILD THE MATRIX HEADER ---
                    let tableHTML = `
                        <h3 style="margin-bottom:5px;">${sport} - ${gender}</h3>
                        <div style="overflow-x:auto;">
                        <table class="r1aa-table" style="font-size: 0.8rem; min-width: 100%;">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="background:#e2e8f0; width: 150px;">EVENT / DELEGATION</th>
                                    ${subEvents.map(sub => `<th colspan="3" class="header-main">${sub}</th>`).join('')}
                                    <th colspan="3" class="header-main" style="background:#334155;">TOTAL</th>
                                </tr>
                                <tr>
                                    ${subEvents.map(() => `
                                        <th style="font-size:0.7rem; width:25px;">G</th>
                                        <th style="font-size:0.7rem; width:25px;">S</th>
                                        <th style="font-size:0.7rem; width:25px;">B</th>
                                    `).join('')}
                                    <th style="font-size:0.7rem; width:30px; background:#f1f5f9;">G</th>
                                    <th style="font-size:0.7rem; width:30px; background:#f1f5f9;">S</th>
                                    <th style="font-size:0.7rem; width:30px; background:#f1f5f9;">B</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // --- BUILD THE ROWS (SDOs) ---
                    SDO_LIST.forEach(sdo => {
                        let rowTotal = { G:0, S:0, B:0 };
                        let rowHTML = `<tr><td style="text-align:left; font-weight:600;">${sdo}</td>`;

                        // Loop through Sub-Events (Columns)
                        subEvents.forEach(sub => {
                            // Calculate Medals for this Cell
                            let cellCounts = { G:0, S:0, B:0 };
                            
                            // Filter Data: Match Cat, Sport, Gender, SubEvent, AND SDO
                            const matches = GLOBAL_DATA.filter(d => 
                                d.category === category && 
                                d.event === sport && 
                                d.gender === gender && 
                                d.subEvent === sub &&
                                d.sdo === sdo
                            );

                            matches.forEach(m => {
                                if(m.medal === 'GOLD') cellCounts.G++;
                                if(m.medal === 'SILVER') cellCounts.S++;
                                if(m.medal === 'BRONZE') cellCounts.B++;
                            });

                            // Add to Row Totals
                            rowTotal.G += cellCounts.G;
                            rowTotal.S += cellCounts.S;
                            rowTotal.B += cellCounts.B;

                            // Render Cell (Empty if 0 to match photo style)
                            rowHTML += `
                                <td>${cellCounts.G || ''}</td>
                                <td>${cellCounts.S || ''}</td>
                                <td style="border-right: 2px solid #cbd5e1;">${cellCounts.B || ''}</td>
                            `;
                        });

                        // Render Row Total
                        rowHTML += `
                            <td style="background:#f8fafc; font-weight:bold;">${rowTotal.G || ''}</td>
                            <td style="background:#f8fafc; font-weight:bold;">${rowTotal.S || ''}</td>
                            <td style="background:#f8fafc; font-weight:bold;">${rowTotal.B || ''}</td>
                        </tr>`;

                        tableHTML += rowHTML;
                    });

                    tableHTML += `</tbody></table></div>`;
                    container.innerHTML = tableHTML;
                    display.appendChild(container);
                });
            });
        }

        // --- RENDER: OVERALL ---
        function renderOverallRegular() {
            const display = document.getElementById('mainDisplay');
            let tally = {};
            SDO_LIST.forEach(sdo => {
                tally[sdo] = { elem: {G:0,S:0,B:0}, sec: {G:0,S:0,B:0}, total: {G:0,S:0,B:0} };
            });

            GLOBAL_DATA.forEach(d => {
                if (!tally[d.sdo]) return;
                let type = d.category === 'ELEMENTARY' ? 'elem' : d.category === 'SECONDARY' ? 'sec' : null;
                if (type) {
                    let m = d.medal.charAt(0); 
                    tally[d.sdo][type][m]++;
                    tally[d.sdo].total[m]++;
                }
            });

            let sortedSDOs = Object.keys(tally).sort((a, b) => {
                if (tally[b].total.G !== tally[a].total.G) return tally[b].total.G - tally[a].total.G;
                if (tally[b].total.S !== tally[a].total.S) return tally[b].total.S - tally[a].total.S;
                return tally[b].total.B - tally[a].total.B;
            });

            let html = `
                <div class="section-title">OVERALL REGULAR GAMES</div>
                <table class="r1aa-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">SDO</th>
                            <th colspan="3" class="header-sub">ELEMENTARY</th>
                            <th colspan="3" class="header-sub">SECONDARY</th>
                            <th colspan="3" class="header-main">OVERALL</th>
                            <th rowspan="2" class="header-main">RANK</th>
                        </tr>
                        <tr>
                            <th>G</th><th>S</th><th>B</th>
                            <th>G</th><th>S</th><th>B</th>
                            <th>G</th><th>S</th><th>B</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedSDOs.forEach((sdo, index) => {
                const t = tally[sdo];
                html += `
                    <tr>
                        <td style="text-align:left; font-weight:bold;">${sdo}</td>
                        <td>${t.elem.G}</td><td>${t.elem.S}</td><td>${t.elem.B}</td>
                        <td>${t.sec.G}</td><td>${t.sec.S}</td><td>${t.sec.B}</td>
                        <td style="font-weight:bold; color:var(--primary);">${t.total.G}</td>
                        <td style="font-weight:bold;">${t.total.S}</td>
                        <td style="font-weight:bold; color:#cd7f32;">${t.total.B}</td>
                        <td>${index + 1}</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            display.innerHTML = html;
        }

        function renderBestPerforming() {
            document.getElementById('mainDisplay').innerHTML = "<h3>Best Performing Table logic to be implemented.</h3>";
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });
        
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "../index.html";
        });
    </script>
</body>
</html>
